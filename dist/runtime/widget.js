System.register(["jimu-core","jimu-arcgis","jimu-ui","jimu-theme"],(function(e,r){var o={},t={},n={},a={};return{setters:[function(e){o.DataSourceManager=e.DataSourceManager,o.React=e.React,o.css=e.css,o.hooks=e.hooks,o.jsx=e.jsx},function(e){t.JimuMapViewComponent=e.JimuMapViewComponent,t.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules},function(e){n.Alert=e.Alert,n.Button=e.Button,n.Loading=e.Loading,n.LoadingType=e.LoadingType,n.SVG=e.SVG},function(e){a.useTheme=e.useTheme}],execute:function(){e((()=>{var e={1688:e=>{e.exports="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTciIHZpZXdCb3g9IjAgMCAxNiAxNyIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4NCjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNMCAxMlYxMC41SDFMMSAxMkgyLjVWMTNIMUMwLjQ0NzcxNiAxMyAwIDEyLjU1MjMgMCAxMlpNMSAxSDIuNVYyTDEgMlYzLjVIMFYyQzAgMS40NDc3MiAwLjQ0NzcxNSAxIDEgMVpNMSA4LjVIMFY1LjVIMVY4LjVaTTQuNSAyVjFINy41VjJINC41Wk05LjUgMlYxSDExQzExLjU1MjMgMSAxMiAxLjQ0NzcyIDEyIDJWMy41SDExVjJIOS41Wk0xNC4zMTMzIDE2LjAyMDRMMTAuNzc3OCAxMi40ODQ5TDcuMjQyMjYgMTYuMDIwNEw2LjUzNTE2IDE1LjMxMzNMMTAuMDcwNyAxMS43Nzc4TDYuNTM1MTYgOC4yNDIyNkw3LjI0MjI2IDcuNTM1MTZMMTAuNzc3OCAxMS4wNzA3TDE0LjMxMzMgNy41MzUxNkwxNS4wMjA0IDguMjQyMjZMMTEuNDg0OSAxMS43Nzc4TDE1LjAyMDQgMTUuMzEzM0wxNC4zMTMzIDE2LjAyMDRaIiBmaWxsPSJibGFjayIvPg0KPC9zdmc+DQo="},1888:e=>{"use strict";e.exports=a},2686:e=>{"use strict";e.exports=t},4321:e=>{"use strict";e.exports=n},9244:e=>{"use strict";e.exports=o}},r={};function i(o){var t=r[o];if(void 0!==t)return t.exports;var n=r[o]={exports:{}};return e[o](n,n.exports,i),n.exports}i.n=e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return i.d(r,{a:r}),r},i.d=(e,r)=>{for(var o in r)i.o(r,o)&&!i.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:r[o]})},i.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.p="";var s={};return i.p=window.jimuConfig.baseUrl,(()=>{"use strict";i.r(s),i.d(s,{__set_webpack_public_path__:()=>te,default:()=>oe});var e,r=i(9244),o=i(2686),t=i(4321);!function(e){e.QUERY_ERROR="QUERY_ERROR",e.NETWORK_ERROR="NETWORK_ERROR",e.VALIDATION_ERROR="VALIDATION_ERROR",e.GEOMETRY_ERROR="GEOMETRY_ERROR"}(e||(e={}));var n=i(1888);const a=e=>{var r;return{fontFamily:null==e?void 0:e.fontFamily,fontWeight:null===(r=null==e?void 0:e.fontWeight)||void 0===r?void 0:r.toString(),fontSize:null==e?void 0:e.fontSize,fontStyle:null==e?void 0:e.fontStyle,lineHeight:null==e?void 0:e.lineHeight,color:null==e?void 0:e.color}},l=(e,o={})=>(0,r.css)(Object.assign({display:"flex",flexFlow:"column"===e?"column nowrap":"row nowrap"},o)),c=(e,r={})=>l(e,Object.assign({flex:"0 0 auto"},r)),u=()=>(e=>{var o,t,n,i,s,u;const d=e.sys.spacing,p=e.sys.color,g=e.sys.typography;return{parent:l("column",{flex:"1 1 auto",overflowY:"auto",blockSize:"100%",gap:null==d?void 0:d(2),backgroundColor:null===(o=null==p?void 0:p.surface)||void 0===o?void 0:o.paper}),header:c("row",{alignItems:"center",justifyContent:"end",paddingInline:null==d?void 0:d(1)}),cols:c("row",{borderBlockStart:`1px solid ${null===(t=null==p?void 0:p.surface)||void 0===t?void 0:t.backgroundHint}`,borderBlockEnd:`1px solid ${null===(n=null==p?void 0:p.surface)||void 0===n?void 0:n.backgroundHint}`}),col:(0,r.css)({flex:"1 1 0",display:"flex",justifyContent:"center",padding:null==d?void 0:d(1)}),body:l("column",{flex:"1 1 0",overflow:"auto"}),list:c("column"),row:c("row",{gap:null==d?void 0:d(2),padding:null==d?void 0:d(1),borderBlockEnd:`1px solid ${null===(i=null==p?void 0:p.surface)||void 0===i?void 0:i.backgroundHint}`,alignItems:"center"}),column:(0,r.css)({flex:"1 1 0",minWidth:0}),actions:c("row",{alignItems:"center"}),loading:(0,r.css)({padding:null==d?void 0:d(1.5)}),error:(0,r.css)({padding:null==d?void 0:d(1.5)}),errorWrap:l("column",{flex:"1 1 auto",gap:null==d?void 0:d(1),padding:null==d?void 0:d(2)}),errorHint:(0,r.css)({color:null===(s=null==p?void 0:p.surface)||void 0===s?void 0:s.backgroundHint}),buttons:c("row",{gap:null==d?void 0:d(1)}),footer:c("row",Object.assign({borderBlockStart:`1px solid ${null===(u=null==p?void 0:p.surface)||void 0===u?void 0:u.backgroundHint}`},a(null==g?void 0:g.label2)))}})((0,n.useTheme)()),d=["esri/symbols/SimpleFillSymbol","esri/Graphic","esri/layers/GraphicsLayer","esri/tasks/QueryTask","esri/rest/support/Query","esri/geometry/geometryEngine","esri/geometry/Extent"],p="FASTIGHET",g="BOSTADR",v=[0,180,216,.4],h=new Map,f=new Map;var y=function(e,r,o,t){return new(o||(o=Promise))((function(n,a){function i(e){try{l(t.next(e))}catch(e){a(e)}}function s(e){try{l(t.throw(e))}catch(e){a(e)}}function l(e){var r;e.done?n(e.value):(r=e.value,r instanceof o?r:new o((function(e){e(r)}))).then(i,s)}l((t=t.apply(e,r||[])).next())}))};const w=(e,o)=>{const t=r.React.useRef(null),n=r.React.useRef(new Map),a=r.hooks.useEventCallback((r=>{e&&r&&(t.current?r.map.findLayerById(t.current.id)||r.map.add(t.current):(t.current=new e.GraphicsLayer({id:`${o}-property-highlight-layer`,listMode:"hide"}),r.map.add(t.current)))})),i=r.hooks.useEventCallback((()=>{t.current&&t.current.removeAll(),n.current.clear()})),s=r.hooks.useEventCallback(((e,r)=>{const o=t.current;if(!o)return;const a=r(e),i=n.current.get(a);i&&i.length>0&&(o.removeMany(i),n.current.delete(a))})),l=r.hooks.useEventCallback(((r,o,i,l,c,u)=>{if(!e||!r||!o)return;a(o);const d=t.current;if(!d)return;const p=i(r.attributes||null),g=((r,o)=>e?new e.SimpleFillSymbol({color:r,outline:{color:[r[0],r[1],r[2],1],width:o}}):null)(c,u);if(!g)return;const v=r.clone();if(v.symbol=g,v.attributes=Object.assign(Object.assign({},v.attributes||{}),{FNR:p}),s(p,l),d.add(v),!p)return;const h=l(p),f=n.current.get(h)||[];n.current.set(h,[...f,v])})),c=r.hooks.useEventCallback((e=>{var r;e&&t.current&&(null===(r=e.map)||void 0===r||r.remove(t.current),t.current.destroy(),t.current=null,n.current.clear())}));return r.hooks.useUnmount((()=>{var e,r;t.current&&(null===(r=(e=t.current).destroy)||void 0===r||r.call(e),t.current=null),n.current.clear()})),{graphicsLayerRef:t,graphicsMapRef:n,ensureGraphicsLayer:a,clearGraphics:i,removeGraphicsForFnr:s,addGraphicsToMap:l,destroyGraphicsLayer:c}};function m(e){return!e.valid}var b=function(e,r,o,t){return new(o||(o=Promise))((function(n,a){function i(e){try{l(t.next(e))}catch(e){a(e)}}function s(e){try{l(t.throw(e))}catch(e){a(e)}}function l(e){var r;e.done?n(e.value):(r=e.value,r instanceof o?r:new o((function(e){e(r)}))).then(i,s)}l((t=t.apply(e,r||[])).next())}))};const R=e=>{if(!e)return"";return((new DOMParser).parseFromString(e,"text/html").body.textContent||"").replace(/[\s\u00A0\u200B]+/g," ").trim()},I=(e,r)=>{const o=R(e);return o.length<r?"***":o},E=(e,r,o)=>{const t=R(e.NAMN||"")||o,n=r&&t!==o?(e=>{const r=I(e,3);return"***"===r?r:r.split(" ").filter(Boolean).map((e=>`${e.charAt(0)}${"*".repeat(Math.min(3,e.length-1))}`)).join(" ")})(t):t,a=R(e.BOSTADR||""),i=r&&a?(e=>{const r=I(e,3);return"***"===r?r:`${r.substring(0,2)}${"*".repeat(Math.min(5,r.length-2))}`})(a):a,s=R(e.POSTNR||"").replace(/\s+/g,""),l=R(e.POSTADR||""),c=R(e.ORGNR||"");return[n,i,s&&l?`${s} ${l}`:s||l].filter(Boolean).join(", ")+(c?` (${c})`:"")},A=(e,r)=>{const o=null==r?void 0:r.trim();return o?`${e} (${o})`:e},S=(e,r)=>`${e}_${r}`,M=(e,r)=>{try{const t=new URL(e);return!(e=>{const r=e.toLowerCase();return"localhost"===r||"127.0.0.1"===r||"::1"===r||"[::1]"===r||/^10\./.test(r)||/^172\.(1[6-9]|2[0-9]|3[0-1])\./.test(r)||/^192\.168\./.test(r)})(t.hostname)&&(e=>"https:"===e.protocol&&(""===e.port||"443"===e.port))(t)&&(o=t.pathname,/\/(MapServer|FeatureServer)\/\d+(\/query)?$/.test(o))&&((e,r)=>!r||0===r.length||r.some((r=>e===r||e.endsWith("."+r))))(t.hostname,r)}catch(e){return!1}var o},O=(e,r="Invalid FNR: must be a safe integer")=>{if("number"==typeof e){if(!Number.isFinite(e)||!Number.isSafeInteger(e)||e<0)throw new Error(r);return`FNR = ${e}`}const o=String(e).replace(/'/g,"''");if(!o.trim())throw new Error("Invalid FNR: cannot be empty or whitespace-only");return`FNR = '${o}'`},x=e=>{if(!e)return null;return e.FNR||e.fnr||null},j=e=>null!=e?String(e):"",T=e=>"AbortError"===(null==e?void 0:e.name)||"string"==typeof(null==e?void 0:e.message)&&e.message.toLowerCase().includes("abort"),D=(e,r)=>{var o;return e?"string"==typeof e?e:(null===(o=e.details)||void 0===o?void 0:o.message)||e.message||r:r},k=e=>{var r,o,t,n,a;if(!e)return null;const i=null===(o=null===(r=e.getLayerDefinition)||void 0===r?void 0:r.call(e))||void 0===o?void 0:o.url;if(i)return i;const s=null===(n=null===(t=e.getDataSourceJson)||void 0===t?void 0:t.call(e))||void 0===n?void 0:n.url;return s||((null==e?void 0:e.url)||(null===(a=null==e?void 0:e.layer)||void 0===a?void 0:a.url)||null)},F=(e,r,o)=>({valid:!1,error:{type:e,message:r},failureReason:o}),N=e=>null!==e&&"function"==typeof e.query,_=(e,r)=>{var o;const t=null===(o=e.features)||void 0===o?void 0:o[0];if(!(null==t?void 0:t.attributes)||!(null==t?void 0:t.geometry))return null;const n=r(t.attributes);return n?{fnr:n,attrs:t.attributes,graphic:t}:null},P=e=>b(void 0,void 0,void 0,(function*(){const{batch:r,config:t,dsManager:n,maxResults:a,currentRowCount:i,signal:s,helpers:l,messages:c}=e,[u]=yield(0,o.loadArcGISJSAPIModules)(["esri/core/promiseUtils"]),d=yield u.eachAlways(r.map((e=>(e=>b(void 0,void 0,void 0,(function*(){const{fnr:r,config:o,dsManager:t,signal:n,helpers:a}=e;try{if(null==n?void 0:n.aborted)throw new DOMException("Aborted","AbortError");return{ownerFeatures:yield a.queryOwnerByFnr(r,o.ownerDataSourceId,t,{signal:n}),queryFailed:!1}}catch(e){if(a.isAbortError(e))throw e instanceof Error?e:new Error(String(e));return{ownerFeatures:[],queryFailed:!0}}})))({fnr:e.fnr,config:{ownerDataSourceId:t.ownerDataSourceId},dsManager:n,signal:s,helpers:{queryOwnerByFnr:l.queryOwnerByFnr,isAbortError:l.isAbortError}}).then((r=>Object.assign(Object.assign({},r),{validated:e})))))),p=[],g=[];for(const e of d){if(e.error){l.isAbortError(e.error)||console.log("Owner query failed for batch item:",e.error);continue}if(!e.value){console.log("Owner query returned no value for batch item");continue}const{validated:r,ownerFeatures:o,queryFailed:n}=e.value;if(i+p.length>=a)break;const s=L({fnr:r.fnr,propertyAttrs:r.attrs,ownerFeatures:o,queryFailed:n,propertyGraphic:r.graphic,config:{enablePIIMasking:t.enablePIIMasking},helpers:{createRowId:l.createRowId,formatPropertyWithShare:l.formatPropertyWithShare,formatOwnerInfo:l.formatOwnerInfo},messages:c}),u=a-(i+p.length),d=s.slice(0,u);p.push(...d),d.length>0&&g.push({graphic:r.graphic,fnr:r.fnr})}return{rows:p,graphics:g}})),C=e=>({id:e.createRowId(e.fnr,e.objectId),FNR:e.fnr,UUID_FASTIGHET:e.uuidFastighet,FASTIGHET:e.fastighet,BOSTADR:e.bostadr,graphic:e.graphic}),L=e=>{const{fnr:r,propertyAttrs:o,ownerFeatures:t,queryFailed:n,propertyGraphic:a,config:i,helpers:s,messages:l}=e;return t.length>0?t.map((e=>{const o=e.attributes;return C({fnr:r,objectId:o.OBJECTID,uuidFastighet:o.UUID_FASTIGHET,fastighet:s.formatPropertyWithShare(o.FASTIGHET,o.ANDEL||""),bostadr:s.formatOwnerInfo(o,i.enablePIIMasking,l.unknownOwner),graphic:a,createRowId:s.createRowId})})):[C({fnr:r,objectId:o.OBJECTID,uuidFastighet:o.UUID_FASTIGHET,fastighet:o.FASTIGHET,bostadr:n?l.errorOwnerQueryFailed:l.errorNoDataAvailable,graphic:a,createRowId:s.createRowId})]};var G=function(e,r,o,t){return new(o||(o=Promise))((function(n,a){function i(e){try{l(t.next(e))}catch(e){a(e)}}function s(e){try{l(t.throw(e))}catch(e){a(e)}}function l(e){var r;e.done?n(e.value):(r=e.value,r instanceof o?r:new o((function(e){e(r)}))).then(i,s)}l((t=t.apply(e,r||[])).next())}))};const z=(e,r)=>`${e}:${JSON.stringify(r)}`,B=(e,r,o,t)=>{const n=Date.now(),a=e.get(r);if(a&&n-a.timestamp<300){if(null==t?void 0:t.aborted){const e=new Error("AbortError");return e.name="AbortError",Promise.reject(e)}return a.promise}const i=o().catch((e=>{throw e instanceof Error?e:new Error(String(e))})).finally((()=>{setTimeout((()=>e.delete(r)),300)}));return e.set(r,{promise:i,timestamp:n}),i},V=(e,r,o,t)=>G(void 0,void 0,void 0,(function*(){const n=z("owner",{fnr:String(e),dsId:r});return B(f,n,(()=>G(void 0,void 0,void 0,(function*(){var n,a;try{if(null===(n=null==t?void 0:t.signal)||void 0===n?void 0:n.aborted){const e=new Error("AbortError");throw e.name="AbortError",e}const i=o.getDataSource(r);if(!i)throw new Error("Owner data source not found");const s=yield i.query({where:O(e),returnGeometry:!1,outFields:["*"]});if(null===(a=null==t?void 0:t.signal)||void 0===a?void 0:a.aborted){const e=new Error("AbortError");throw e.name="AbortError",e}return(null==s?void 0:s.records)?s.records.map((e=>e.getData())):[]}catch(e){if(T(e))throw e;throw new Error(D(e,"Owner query failed"))}}))),null==t?void 0:t.signal)})),Q=()=>{h.clear(),f.clear()},U=(e,r,t,n,a,i)=>G(void 0,void 0,void 0,(function*(){var t,s,l;try{if(null===(t=null==i?void 0:i.signal)||void 0===t?void 0:t.aborted){const e=new Error("AbortError");throw e.name="AbortError",e}if(!e||0===e.length)return new Map;const c=n.getDataSource(r);if(!c)throw new Error("Property data source not found");const u=c.getLayerDefinition(),d=null==u?void 0:u.url;if(!d)throw new Error("Property layer URL not available");const p=yield(0,o.loadArcGISJSAPIModules)(["esri/tasks/QueryTask","esri/rest/support/RelationshipQuery"]),[g,v]=p,h=new g({url:d}),f=new v,y=[],w=new Map,m=yield c.query({where:e.map((e=>O(e))).join(" OR "),outFields:["FNR","OBJECTID"],returnGeometry:!1});if(null===(s=null==i?void 0:i.signal)||void 0===s?void 0:s.aborted){const e=new Error("AbortError");throw e.name="AbortError",e}if(!(null==m?void 0:m.records)||0===m.records.length)return new Map;m.records.forEach((e=>{const r=e.getData(),o=r.OBJECTID,t=String(r.FNR);y.push(o),w.set(o,t)})),f.objectIds=y,f.relationshipId=a,f.outFields=["*"];const b=yield h.executeRelationshipQuery(f);if(null===(l=null==i?void 0:i.signal)||void 0===l?void 0:l.aborted){const e=new Error("AbortError");throw e.name="AbortError",e}const R=new Map;return y.forEach((e=>{const r=b[e],o=w.get(e);if(o&&r&&r.features){const e=r.features.map((e=>e.attributes));R.set(o,e)}})),R}catch(e){if(T(e))throw e;throw new Error(D(e,"Relationship query failed"))}})),q=()=>{try{if("undefined"==typeof window)return!1;if(!0===(null===navigator||void 0===navigator?void 0:navigator.globalPrivacyControl))return!1;const e=(null===navigator||void 0===navigator?void 0:navigator.doNotTrack)||(null===window||void 0===window?void 0:window.doNotTrack)||(null===navigator||void 0===navigator?void 0:navigator.msDoNotTrack);if("1"===e||"yes"===e)return!1;if(("undefined"!=typeof document&&document.cookie||"").includes("esri_disallow_tracking=1"))return!1;const r=window.localStorage?window.localStorage.getItem("esri_allow_tracking"):null;return"false"!==r&&"true"===r}catch(e){return!1}},W=e=>{if(q())try{console.log("[Property Widget Telemetry]",e)}catch(e){console.log("Telemetry tracking failed",e)}},H=e=>{if(q())try{W({category:"Performance",action:e.operation,label:e.success?"success":"failure",value:Math.round(e.duration)}),e.error&&W({category:"Error",action:e.operation,label:e.error})}catch(e){console.log("Performance tracking failed",e)}},$=(e,r,o)=>{var t;if(q())try{const n="string"==typeof r?r:(null==r?void 0:r.message)||(null===(t=null==r?void 0:r.details)||void 0===t?void 0:t.message)||"Unknown error";W({category:"Error",action:e,label:o?`${n}: ${o}`:n})}catch(e){console.log("Error tracking failed",e)}},J=(e,r)=>{q()&&W({category:"Feature",action:e,label:r?"enabled":"disabled"})};var Y=i(1688),Z=i.n(Y),K=function(e,r,o,t){return new(o||(o=Promise))((function(n,a){function i(e){try{l(t.next(e))}catch(e){a(e)}}function s(e){try{l(t.throw(e))}catch(e){a(e)}}function l(e){var r;e.done?n(e.value):(r=e.value,r instanceof o?r:new o((function(e){e(r)}))).then(i,s)}l((t=t.apply(e,r||[])).next())}))};const X=e=>{const{graphicsToAdd:r,selectedRows:o,getCurrentView:t,helpers:n,highlightColor:a,outlineWidth:i}=e,s=t();if(!s)return void console.log("syncSelectionGraphics: no active view, deferring graphics sync");const l=(e=>{const{graphicsToAdd:r,selectedRows:o,view:t,helpers:n,highlightColor:a,outlineWidth:i}=e;if(!t)return console.log("syncGraphicsWithState: view is null or undefined, cannot sync graphics"),!1;const s=new Set(o.map((e=>n.normalizeFnrKey(e.FNR))));return r.forEach((({graphic:e,fnr:r})=>{const o=n.normalizeFnrKey(r);s.has(o)&&n.addGraphicsToMap(e,t,n.extractFnr,n.normalizeFnrKey,a,i)})),!0})({graphicsToAdd:r,selectedRows:o,view:s,helpers:n,highlightColor:a,outlineWidth:i});l||console.log("syncSelectionGraphics: failed to sync graphics with state")};class ee extends r.React.Component{constructor(e){super(e),this.state={hasError:!1,error:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,r){console.log(this.props.translate("errorBoundaryConsoleLog"),e,r),$("error_boundary",e,r.componentStack)}render(){return this.state.hasError?(0,r.jsx)("div",{css:this.props.styles.errorWrap},(0,r.jsx)(t.Alert,{type:"error",withIcon:!0,text:this.props.translate("errorBoundaryMessage")}),this.state.error&&(0,r.jsx)("div",{css:this.props.styles.errorHint},this.state.error.message)):this.props.children}}const re=n=>{const{config:a,id:i,useMapWidgetIds:s}=n,l=u(),c=r.hooks.useTranslation(),{modules:f,loading:R,error:I}=(()=>{const[e,t]=r.React.useState(null),[n,a]=r.React.useState(!0),[i,s]=r.React.useState(null);return r.hooks.useEffectOnce((()=>{const e=null===globalThis||void 0===globalThis?void 0:globalThis.__ESRI_TEST_STUB__;y(void 0,void 0,void 0,"function"!=typeof e?function*(){try{const e=yield(0,o.loadArcGISJSAPIModules)(d.slice()),[r,n,a,i,s,l,c]=e;t({SimpleFillSymbol:r,Graphic:n,GraphicsLayer:a,QueryTask:i,Query:s,geometryEngine:l,Extent:c})}catch(e){s(e)}finally{a(!1)}}:function*(){try{const r=yield Promise.resolve(e(d));t(r)}catch(e){s(e)}finally{a(!1)}})})),{modules:e,loading:n,error:i}})(),{ensureGraphicsLayer:L,clearGraphics:q,removeGraphicsForFnr:Y,addGraphicsToMap:ee,destroyGraphicsLayer:re}=w(f,i),{disablePopup:oe,restorePopup:te}=(()=>{const e=r.React.useRef(new Map),o=r.hooks.useEventCallback((r=>{if(!r)return;const o=r.popup,t=e.current.get(r);o&&void 0!==t&&(o.autoOpenEnabled=t,e.current.delete(r))})),t=r.hooks.useEventCallback((r=>{if(!r)return;const o=r.popup;o&&"boolean"==typeof o.autoOpenEnabled&&(e.current.has(r)||e.current.set(r,o.autoOpenEnabled),o.autoOpenEnabled=!1)})),n=r.hooks.useEventCallback((e=>{o(e)}));return{disablePopup:t,restorePopup:o,cleanup:n}})(),{getController:ne,releaseController:ae,abortAll:ie}=(()=>{const e=r.React.useRef([]),o=r.React.useRef(new Set),t=r.hooks.useEventCallback((()=>{let r=e.current.pop();for(;r&&r.signal.aborted;)r=e.current.pop();const t=r||new AbortController;return o.current.add(t),t})),n=r.hooks.useEventCallback((r=>{o.current.delete(r),r.signal.aborted||e.current.length<10&&e.current.push(r)})),a=r.hooks.useEventCallback((()=>{o.current.forEach((e=>{e.signal.aborted||e.abort()})),o.current.clear(),e.current=[]}));return r.hooks.useUnmount((()=>{a()})),{getController:t,releaseController:n,abortAll:a}})(),se=r.React.useRef(null);se.current||(se.current=r.DataSourceManager.getInstance());const le=r.React.useRef(0),[ce,ue]=r.React.useState({loading:!1,error:null,selectedProperties:[]}),de=a.maxResults,pe=a.enableToggleRemoval,ge=a.enablePIIMasking,ve=null==s?void 0:s[0],he=r.hooks.useEventCallback((e=>{Y(e,j),ue((r=>{const o=[],t=[];return r.selectedProperties.forEach((r=>{r.FNR!==e?t.push(r):o.push(r)})),0===o.length?r:(W({category:"Property",action:"remove",value:o.length}),Object.assign(Object.assign({},r),{selectedProperties:t}))}))})),fe=r.hooks.useEventCallback((()=>{ie(),Q(),q(),ue((e=>(W({category:"Property",action:"clear_all",value:e.selectedProperties.length}),Object.assign(Object.assign({},e),{selectedProperties:[],error:null}))))})),ye=r.hooks.useEventCallback((()=>K(void 0,void 0,void 0,(function*(){const r=Ie();if(!r)return void we(e.VALIDATION_ERROR,c("errorNoMapPoint"));const o=ce.selectedProperties.map((e=>e.FNR));if(0===o.length)return void we(e.VALIDATION_ERROR,c("noPropertiesSelected"));if(!a.propertyDataSourceId||!se.current)return void we(e.VALIDATION_ERROR,c("errorNoDataAvailable"));ue((e=>Object.assign(Object.assign({},e),{loading:!0,error:null})));const t=ne();try{const n=yield((e,r,o,t)=>G(void 0,void 0,void 0,(function*(){var n,a;try{if(null===(n=null==t?void 0:t.signal)||void 0===n?void 0:n.aborted){const e=new Error("AbortError");throw e.name="AbortError",e}if(!e||0===e.length)return null;const i=o.getDataSource(r);if(!i)throw new Error("Property data source not found");const s=e.map((e=>O(e))).join(" OR "),l=yield i.query({where:s,returnGeometry:!0,outFields:["FNR"]});if(null===(a=null==t?void 0:t.signal)||void 0===a?void 0:a.aborted){const e=new Error("AbortError");throw e.name="AbortError",e}if(!(null==l?void 0:l.records)||0===l.records.length)return null;let c=null;return l.records.forEach((e=>{const r=e.getData().geometry;r&&r.extent&&(c=c?c.union(r.extent):r.extent.clone())})),c}catch(e){if(T(e))throw e;throw new Error(D(e,"Extent query failed"))}})))(o,a.propertyDataSourceId,se.current,{signal:t.signal});if(t.signal.aborted)return void ue((e=>Object.assign(Object.assign({},e),{loading:!1})));if(!n)return void we(e.VALIDATION_ERROR,c("errorNoDataAvailable"));yield r.goTo(n.expand(1.2),{duration:1e3}),ue((e=>Object.assign(Object.assign({},e),{loading:!1}))),W({category:"Navigation",action:"zoom_to_results",value:o.length})}catch(r){if(T(r))return void ue((e=>Object.assign(Object.assign({},e),{loading:!1})));we(e.QUERY_ERROR,c("errorQueryFailed")),$("zoom_to_results",r)}finally{ae(t)}})))),we=r.hooks.useEventCallback(((e,r,o)=>{ue((t=>Object.assign(Object.assign({},t),{loading:!1,error:{type:e,message:r,details:o}})))})),me=r.hooks.useEventCallback((r=>K(void 0,void 0,void 0,(function*(){ie();const o=(e=>{const r=performance.now();return{success:()=>{const o=performance.now()-r;H({operation:e,duration:o,success:!0})},failure:o=>{const t=performance.now()-r;H({operation:e,duration:t,success:!1,error:o})}}})("map_click_query"),t=((e,r,o,t)=>r?(null==e?void 0:e.mapPoint)?{valid:!0,data:{mapPoint:e.mapPoint}}:{valid:!1,error:{type:"GEOMETRY_ERROR",message:t("errorNoMapPoint")},failureReason:"no_map_point"}:{valid:!1,error:{type:"VALIDATION_ERROR",message:t("errorLoadingModules")},failureReason:"modules_not_loaded"})(r,f,0,c);if(m(t)){const{error:e}=t;return we(e.type,e.message),o.failure(e.type),void $("map_click_validation",e.type,e.message)}const{mapPoint:n}=t.data,i=(e=>{const{propertyDsId:r,ownerDsId:o,dsManager:t,allowedHosts:n,translate:a}=e;if(!r||!o)return F("VALIDATION_ERROR",a("errorNoDataAvailable"),"missing_data_sources");if(!t)return F("QUERY_ERROR",a("errorQueryFailed"),"no_data_source_manager");const i=t.getDataSource(r),s=t.getDataSource(o);if(!i||!s)return F("VALIDATION_ERROR",a("errorNoDataAvailable"),"missing_data_source_instance");if(!N(i))return F("VALIDATION_ERROR",a("errorNoDataAvailable"),"property_ds_not_queryable");if(!N(s))return F("VALIDATION_ERROR",a("errorNoDataAvailable"),"owner_ds_not_queryable");const l=null==n?void 0:n.map((e=>e.trim())).filter((e=>e.length>0)),c=k(i);if(!c||!M(c,l))return F("VALIDATION_ERROR",a("errorHostNotAllowed"),"property_disallowed_host");const u=k(s);return u&&M(u,l)?{valid:!0,data:{manager:t}}:F("VALIDATION_ERROR",a("errorHostNotAllowed"),"owner_disallowed_host")})({propertyDsId:a.propertyDataSourceId,ownerDsId:a.ownerDataSourceId,dsManager:se.current,allowedHosts:a.allowedHosts,translate:c});if(m(i)){const{error:e,failureReason:r}=i;return we(e.type,e.message),o.failure(r),void $("map_click",r)}const{manager:s}=i.data,l=le.current+1;le.current=l;const u=()=>l!==le.current;ue((e=>Object.assign(Object.assign({},e),{loading:!0,error:null})));const d=ne();try{const e=yield(g=n,y=a.propertyDataSourceId,w=s,R={signal:d.signal},G(void 0,void 0,void 0,(function*(){var e;const r=z("property",{x:Math.round(100*g.x)/100,y:Math.round(100*g.y)/100,wkid:null===(e=g.spatialReference)||void 0===e?void 0:e.wkid,dsId:y});return B(h,r,(()=>G(void 0,void 0,void 0,(function*(){var e,r;try{if(null===(e=null==R?void 0:R.signal)||void 0===e?void 0:e.aborted){const e=new Error("AbortError");throw e.name="AbortError",e}const o=w.getDataSource(y);if(!o)throw new Error("Property data source not found");const t=yield o.query({geometry:g,returnGeometry:!0,outFields:["*"],spatialRel:"esriSpatialRelIntersects"});if(null===(r=null==R?void 0:R.signal)||void 0===r?void 0:r.aborted){const e=new Error("AbortError");throw e.name="AbortError",e}return(null==t?void 0:t.records)?t.records.map((e=>{const r=e.getData();return{features:[r],propertyId:r.attributes.FNR}})):[]}catch(e){if(T(e))throw e;throw new Error(D(e,"Property query failed"))}}))),null==R?void 0:R.signal)})));if(d.signal.aborted||u()){if(u())return;return ue((e=>Object.assign(Object.assign({},e),{loading:!1}))),void o.failure("aborted")}if(!e.length){if(u())return;return ue((e=>Object.assign(Object.assign({},e),{loading:!1}))),o.success(),void W({category:"Query",action:"property_query",label:"no_results"})}const r=a.enableBatchOwnerQuery&&void 0!==a.relationshipId&&a.propertyDataSourceId,{rowsToProcess:t,graphicsToAdd:i}=r?yield(p={propertyResults:e,config:{propertyDataSourceId:a.propertyDataSourceId,ownerDataSourceId:a.ownerDataSourceId,enablePIIMasking:ge,relationshipId:a.relationshipId},dsManager:s,maxResults:de,signal:d.signal,helpers:{extractFnr:x,queryOwnersByRelationship:U,createRowId:S,formatPropertyWithShare:A,formatOwnerInfo:E,isAbortError:T},messages:{unknownOwner:c("unknownOwner"),errorOwnerQueryFailed:c("errorOwnerQueryFailed"),errorNoDataAvailable:c("errorNoDataAvailable")}},b(void 0,void 0,void 0,(function*(){const{propertyResults:e,config:r,dsManager:o,maxResults:t,helpers:n,messages:a,signal:i}=p,s=[],l=[],c=new Set,u=[];for(const r of e){const e=_(r,n.extractFnr);if(e&&!c.has(e.fnr)&&(c.add(e.fnr),u.push(e),u.length>=t))break}if(0===u.length)return{rowsToProcess:[],graphicsToAdd:[]};const d=u.map((e=>e.fnr));let g;try{g=yield n.queryOwnersByRelationship(d,r.propertyDataSourceId,r.ownerDataSourceId,o,r.relationshipId,{signal:i})}catch(e){if(n.isAbortError(e))throw e;console.error("Batch owner query failed:",e),g=new Map}for(const{fnr:e,attrs:o,graphic:t}of u){const i=g.get(String(e))||[];if(i.length>0)for(const s of i){const i=n.formatOwnerInfo(s,r.enablePIIMasking,a.unknownOwner),c=n.formatPropertyWithShare(o.FASTIGHET,s.ANDEL);l.push(C({fnr:e,objectId:o.OBJECTID,uuidFastighet:o.UUID_FASTIGHET,fastighet:c,bostadr:i,graphic:t,createRowId:n.createRowId}))}else l.push(C({fnr:e,objectId:o.OBJECTID,uuidFastighet:o.UUID_FASTIGHET,fastighet:o.FASTIGHET,bostadr:a.errorNoDataAvailable,graphic:t,createRowId:n.createRowId}));s.push({graphic:t,fnr:e})}return{rowsToProcess:l,graphicsToAdd:s}}))):yield(e=>b(void 0,void 0,void 0,(function*(){const{propertyResults:r,config:o,dsManager:t,maxResults:n,helpers:a,messages:i,signal:s}=e,l=[],c=[],u=new Set,d=[];for(const e of r){const r=_(e,a.extractFnr);r&&!u.has(r.fnr)&&(u.add(r.fnr),d.push(r))}for(let e=0;e<d.length;){const r=n-c.length;if(r<=0)break;const u=Math.min(r,5,d.length-e),p=d.slice(e,e+u),{rows:g,graphics:v}=yield P({batch:p,config:{ownerDataSourceId:o.ownerDataSourceId,enablePIIMasking:o.enablePIIMasking},dsManager:t,maxResults:n,currentRowCount:c.length,signal:s,helpers:{queryOwnerByFnr:a.queryOwnerByFnr,isAbortError:a.isAbortError,createRowId:a.createRowId,formatPropertyWithShare:a.formatPropertyWithShare,formatOwnerInfo:a.formatOwnerInfo},messages:i});c.push(...g),l.push(...v),e+=u}return{rowsToProcess:c,graphicsToAdd:l}})))({propertyResults:e,config:{ownerDataSourceId:a.ownerDataSourceId,enablePIIMasking:ge},dsManager:s,maxResults:de,signal:d.signal,helpers:{extractFnr:x,queryOwnerByFnr:V,createRowId:S,formatPropertyWithShare:A,formatOwnerInfo:E,isAbortError:T},messages:{unknownOwner:c("unknownOwner"),errorOwnerQueryFailed:c("errorOwnerQueryFailed"),errorNoDataAvailable:c("errorNoDataAvailable")}});if(d.signal.aborted||u()){if(u())return;return ue((e=>Object.assign(Object.assign({},e),{loading:!1}))),void o.failure("aborted")}let l=null,f=null;if(u())return;if(ue((e=>{if(u())return e;const{updatedRows:r,toRemove:o}=((e,r,o,t)=>{const n=new Set,a=[],i=new Set(r.map((e=>j(e.FNR)))),s=new Set(r.map((e=>e.id))),l=new Set,c=new Set;for(const r of e){const e=j(r.FNR);o&&i.has(e)&&!c.has(e)?(n.add(e),c.add(e)):s.has(r.id)||l.has(r.id)||(a.push(r),l.add(r.id))}const u=[...r.filter((e=>!n.has(j(e.FNR)))),...a];return u.length>t&&(u.length=t),{toRemove:n,toAdd:a,updatedRows:u}})(t,e.selectedProperties,pe,de);if(l={updatedRows:r,previousRows:e.selectedProperties},f={graphicsToAdd:i,selectedRows:r,getCurrentView:Ie,helpers:{addGraphicsToMap:ee,extractFnr:x,normalizeFnrKey:j},highlightColor:v,outlineWidth:2},o.size>0){const r=e.selectedProperties.filter((e=>o.has(j(e.FNR))));r.length>0&&W({category:"Property",action:"toggle_remove",value:r.length})}return Object.assign(Object.assign({},e),{loading:!1,selectedProperties:r})})),u())return void ae(d);l&&(e=>{const{updatedRows:r,previousRows:o,removeGraphicsForFnr:t,normalizeFnrKey:n}=e,a=new Set(r.map((e=>n(e.FNR))));o.forEach((e=>{const r=n(e.FNR);a.has(r)||t(e.FNR,n)}))})({updatedRows:l.updatedRows,previousRows:l.previousRows,removeGraphicsForFnr:Y,normalizeFnrKey:j}),f&&X(f),o.success(),W({category:"Query",action:"property_query",label:"success",value:t.length}),J("pii_masking",ge),J("toggle_removal",pe)}catch(r){if(u())return;if(T(r))return ue((e=>Object.assign(Object.assign({},e),{loading:!1}))),void o.failure("aborted");we(e.QUERY_ERROR,c("errorQueryFailed")),o.failure("query_error"),$("property_query",r)}finally{ae(d)}var p,g,y,w,R})))),be=(e=>{const[t,n]=r.React.useState(null),[a,i]=r.React.useState(null);return r.hooks.useEffectOnce((()=>{(0,o.loadArcGISJSAPIModules)(["esri/core/promiseUtils"]).then((([e])=>{i(e)}))})),r.hooks.useUpdateEffect((()=>{a&&e&&n((()=>a.debounce(e)))}),[a,e]),t||e})(me),{onActiveViewChange:Re,getCurrentView:Ie}=(e=>{const{modules:o,ensureGraphicsLayer:t,destroyGraphicsLayer:n,disablePopup:a,restorePopup:i,onMapClick:s}=e,l=r.React.useRef(null),c=r.React.useRef(null),u=r.hooks.useEventCallback((e=>{a(e),t(e),c.current&&c.current.remove(),c.current=e.on("click",s)})),d=r.hooks.useEventCallback((()=>{var e;const r=null===(e=l.current)||void 0===e?void 0:e.view;r&&(i(r),n(r),c.current&&(c.current.remove(),c.current=null))})),p=r.hooks.useEventCallback((e=>{var r;if(!o)return;const t=null==e?void 0:e.view;if(!t)return;const n=null===(r=l.current)||void 0===r?void 0:r.view;n&&n!==t&&d(),l.current=e,u(t)})),g=r.hooks.useEventCallback((()=>{var e;const r=null===(e=l.current)||void 0===e?void 0:e.view;i(r),c.current&&(c.current.remove(),c.current=null),r&&n(r)}));return r.hooks.useUnmount((()=>{g()})),{onActiveViewChange:p,getCurrentView:()=>{var e;return null===(e=l.current)||void 0===e?void 0:e.view},cleanup:g}})({modules:f,ensureGraphicsLayer:L,destroyGraphicsLayer:re,disablePopup:oe,restorePopup:te,onMapClick:be});return r.hooks.useUnmount((()=>{ie(),Q()})),R?(0,r.jsx)("div",{css:l.parent,role:"region","aria-label":c("widgetTitle")},(0,r.jsx)("div",{css:l.loading,role:"status","aria-live":"polite","aria-busy":"true"},(0,r.jsx)(t.Loading,{type:t.LoadingType.Donut}),(0,r.jsx)("div",null,c("loadingModules")))):I?(0,r.jsx)("div",{css:l.parent,role:"region","aria-label":c("widgetTitle")},(0,r.jsx)("div",{css:l.error,role:"alert","aria-live":"assertive"},(0,r.jsx)(t.Alert,{type:"error",withIcon:!0,text:c("errorLoadingModules")}))):(0,r.jsx)("div",{css:l.parent,role:"region","aria-label":c("widgetTitle")},(0,r.jsx)("div",{css:l.header},(0,r.jsx)("div",{css:l.buttons},(0,r.jsx)(t.Button,{type:"tertiary",icon:!0,onClick:ye,title:c("zoomToResults"),disabled:0===ce.selectedProperties.length||ce.loading,"aria-label":c("zoomToResults")},(0,r.jsx)("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor"},(0,r.jsx)("path",{d:"M15.854 14.146l-3.847-3.847A6.5 6.5 0 1 0 10.3 11.7l3.847 3.847a.5.5 0 0 0 .707-.707zM6.5 11a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9z"}),(0,r.jsx)("path",{d:"M6.5 8.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 0 1zm2-2v-2a.5.5 0 0 0-1 0v2a.5.5 0 0 0 1 0z"}))),(0,r.jsx)(t.Button,{type:"tertiary",icon:!0,onClick:fe,title:c("clearAll"),disabled:0===ce.selectedProperties.length}," ",(0,r.jsx)(t.SVG,{src:Z()})))),(0,r.jsx)("div",{css:l.cols},(0,r.jsx)("div",{css:l.col},c("columnFastighet")),(0,r.jsx)("div",{css:l.col},c("columnOwner"))),(0,r.jsx)("div",{css:l.body,role:"main"},ce.loading&&(0,r.jsx)("div",{css:l.loading,role:"status","aria-live":"polite","aria-busy":"true"},(0,r.jsx)(t.Loading,{type:t.LoadingType.Donut}),(0,r.jsx)("div",null,c("loadingData"))),ce.error&&(0,r.jsx)("div",{css:l.error,role:"alert","aria-live":"assertive"},(0,r.jsx)(t.Alert,{type:"error",withIcon:!0,text:ce.error.message}),ce.error.details&&(0,r.jsx)("div",null,ce.error.details)),!ce.loading&&!ce.error&&ce.selectedProperties.length>0&&(0,r.jsx)("div",{css:l.list,role:"list","aria-label":c("widgetTitle")},ce.selectedProperties.map((e=>(0,r.jsx)("div",{css:l.row,role:"listitem",key:e.id},(0,r.jsx)("div",{css:l.column,"data-column":p},e.FASTIGHET),(0,r.jsx)("div",{css:l.column,"data-column":g},e.BOSTADR),(0,r.jsx)("div",{css:l.actions},(0,r.jsx)(t.Button,{type:"tertiary",size:"sm",onClick:()=>he(e.FNR),"aria-label":`${c("removeProperty")} ${e.FASTIGHET}`},c("removeProperty")))))))),(0,r.jsx)("div",{css:l.footer},(0,r.jsx)("div",{css:l.col},c("propertySelected")),(0,r.jsx)("div",{css:l.col},ce.selectedProperties.length)),ve&&(0,r.jsx)(o.JimuMapViewComponent,{useMapWidgetId:ve,onActiveViewChange:Re}))},oe=e=>{const o=u(),t=r.hooks.useTranslation();return(0,r.jsx)(ee,{styles:o,translate:t},(0,r.jsx)(re,Object.assign({},e)))};function te(e){i.p=e}})(),s})())}}}));