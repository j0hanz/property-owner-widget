System.register(["jimu-core","jimu-arcgis","jimu-ui","jimu-theme"],(function(e,r){var t={},o={},n={},a={};return{setters:[function(e){t.DataSourceManager=e.DataSourceManager,t.React=e.React,t.css=e.css,t.hooks=e.hooks,t.jsx=e.jsx},function(e){o.JimuMapViewComponent=e.JimuMapViewComponent,o.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules},function(e){n.Alert=e.Alert,n.Button=e.Button,n.Loading=e.Loading,n.LoadingType=e.LoadingType,n.SVG=e.SVG},function(e){a.useTheme=e.useTheme}],execute:function(){e((()=>{var e={1688:e=>{e.exports="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTciIHZpZXdCb3g9IjAgMCAxNiAxNyIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4NCjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNMCAxMlYxMC41SDFMMSAxMkgyLjVWMTNIMUMwLjQ0NzcxNiAxMyAwIDEyLjU1MjMgMCAxMlpNMSAxSDIuNVYyTDEgMlYzLjVIMFYyQzAgMS40NDc3MiAwLjQ0NzcxNSAxIDEgMVpNMSA4LjVIMFY1LjVIMVY4LjVaTTQuNSAyVjFINy41VjJINC41Wk05LjUgMlYxSDExQzExLjU1MjMgMSAxMiAxLjQ0NzcyIDEyIDJWMy41SDExVjJIOS41Wk0xNC4zMTMzIDE2LjAyMDRMMTAuNzc3OCAxMi40ODQ5TDcuMjQyMjYgMTYuMDIwNEw2LjUzNTE2IDE1LjMxMzNMMTAuMDcwNyAxMS43Nzc4TDYuNTM1MTYgOC4yNDIyNkw3LjI0MjI2IDcuNTM1MTZMMTAuNzc3OCAxMS4wNzA3TDE0LjMxMzMgNy41MzUxNkwxNS4wMjA0IDguMjQyMjZMMTEuNDg0OSAxMS43Nzc4TDE1LjAyMDQgMTUuMzEzM0wxNC4zMTMzIDE2LjAyMDRaIiBmaWxsPSJibGFjayIvPg0KPC9zdmc+DQo="},1888:e=>{"use strict";e.exports=a},2686:e=>{"use strict";e.exports=o},4321:e=>{"use strict";e.exports=n},9244:e=>{"use strict";e.exports=t}},r={};function s(t){var o=r[t];if(void 0!==o)return o.exports;var n=r[t]={exports:{}};return e[t](n,n.exports,s),n.exports}s.n=e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return s.d(r,{a:r}),r},s.d=(e,r)=>{for(var t in r)s.o(r,t)&&!s.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:r[t]})},s.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.p="";var i={};return s.p=window.jimuConfig.baseUrl,(()=>{"use strict";s.r(i),s.d(i,{__set_webpack_public_path__:()=>re,default:()=>ee});var e,r=s(9244),t=s(2686),o=s(4321);!function(e){e.QUERY_ERROR="QUERY_ERROR",e.NETWORK_ERROR="NETWORK_ERROR",e.VALIDATION_ERROR="VALIDATION_ERROR",e.GEOMETRY_ERROR="GEOMETRY_ERROR"}(e||(e={}));var n=s(1888);const a=e=>{var r;return{fontFamily:null==e?void 0:e.fontFamily,fontWeight:null===(r=null==e?void 0:e.fontWeight)||void 0===r?void 0:r.toString(),fontSize:null==e?void 0:e.fontSize,fontStyle:null==e?void 0:e.fontStyle,lineHeight:null==e?void 0:e.lineHeight,color:null==e?void 0:e.color}},l=(e,t={})=>(0,r.css)(Object.assign({display:"flex",flexFlow:"column"===e?"column nowrap":"row nowrap"},t)),c=(e,r={})=>l(e,Object.assign({flex:"0 0 auto"},r)),u=()=>(e=>{var t,o,n,s,i,u;const d=e.sys.spacing,p=e.sys.color,g=e.sys.typography;return{parent:l("column",{flex:"1 1 auto",overflowY:"auto",blockSize:"100%",gap:null==d?void 0:d(2),backgroundColor:null===(t=null==p?void 0:p.surface)||void 0===t?void 0:t.paper}),header:c("row",{alignItems:"center",justifyContent:"end",paddingInline:null==d?void 0:d(1)}),cols:c("row",{borderBlockStart:`1px solid ${null===(o=null==p?void 0:p.surface)||void 0===o?void 0:o.backgroundHint}`,borderBlockEnd:`1px solid ${null===(n=null==p?void 0:p.surface)||void 0===n?void 0:n.backgroundHint}`}),col:(0,r.css)({flex:"1 1 0",display:"flex",justifyContent:"center",padding:null==d?void 0:d(1)}),body:l("column",{flex:"1 1 0",overflow:"auto"}),list:c("column"),row:c("row",{gap:null==d?void 0:d(2),padding:null==d?void 0:d(1),borderBlockEnd:`1px solid ${null===(s=null==p?void 0:p.surface)||void 0===s?void 0:s.backgroundHint}`,alignItems:"center"}),column:(0,r.css)({flex:"1 1 0",minWidth:0}),actions:c("row",{alignItems:"center"}),loading:(0,r.css)({padding:null==d?void 0:d(1.5)}),error:(0,r.css)({padding:null==d?void 0:d(1.5)}),errorWrap:l("column",{flex:"1 1 auto",gap:null==d?void 0:d(1),padding:null==d?void 0:d(2)}),errorHint:(0,r.css)({color:null===(i=null==p?void 0:p.surface)||void 0===i?void 0:i.backgroundHint}),buttons:c("row",{gap:null==d?void 0:d(1)}),footer:c("row",Object.assign({borderBlockStart:`1px solid ${null===(u=null==p?void 0:p.surface)||void 0===u?void 0:u.backgroundHint}`},a(null==g?void 0:g.label2)))}})((0,n.useTheme)()),d=["esri/symbols/SimpleFillSymbol","esri/Graphic","esri/layers/GraphicsLayer"],p="FASTIGHET",g="BOSTADR",v=[0,180,216,.4],h=new Map,f=new Map;var y=function(e,r,t,o){return new(t||(t=Promise))((function(n,a){function s(e){try{l(o.next(e))}catch(e){a(e)}}function i(e){try{l(o.throw(e))}catch(e){a(e)}}function l(e){var r;e.done?n(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,i)}l((o=o.apply(e,r||[])).next())}))};const w=(e,t)=>{const o=r.React.useRef(null),n=r.React.useRef(new Map),a=r.hooks.useEventCallback((r=>{e&&r&&(o.current?r.map.findLayerById(o.current.id)||r.map.add(o.current):(o.current=new e.GraphicsLayer({id:`${t}-property-highlight-layer`,listMode:"hide"}),r.map.add(o.current)))})),s=r.hooks.useEventCallback((()=>{o.current&&o.current.removeAll(),n.current.clear()})),i=r.hooks.useEventCallback(((e,r)=>{const t=o.current;if(!t)return;const a=r(e),s=n.current.get(a);s&&s.length>0&&(t.removeMany(s),n.current.delete(a))})),l=r.hooks.useEventCallback(((r,t,s,l,c,u)=>{if(!e||!r||!t)return;a(t);const d=o.current;if(!d)return;const p=s(r.attributes||null),g=((r,t)=>e?new e.SimpleFillSymbol({color:r,outline:{color:[r[0],r[1],r[2],1],width:t}}):null)(c,u);if(!g)return;const v=r.clone();if(v.symbol=g,v.attributes=Object.assign(Object.assign({},v.attributes||{}),{FNR:p}),i(p,l),d.add(v),!p)return;const h=l(p),f=n.current.get(h)||[];n.current.set(h,[...f,v])})),c=r.hooks.useEventCallback((e=>{var r;e&&o.current&&(null===(r=e.map)||void 0===r||r.remove(o.current),o.current.destroy(),o.current=null,n.current.clear())}));return r.hooks.useUnmount((()=>{var e,r;o.current&&(null===(r=(e=o.current).destroy)||void 0===r||r.call(e),o.current=null),n.current.clear()})),{graphicsLayerRef:o,graphicsMapRef:n,ensureGraphicsLayer:a,clearGraphics:s,removeGraphicsForFnr:i,addGraphicsToMap:l,destroyGraphicsLayer:c}};var m=function(e,r,t,o){return new(t||(t=Promise))((function(n,a){function s(e){try{l(o.next(e))}catch(e){a(e)}}function i(e){try{l(o.throw(e))}catch(e){a(e)}}function l(e){var r;e.done?n(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,i)}l((o=o.apply(e,r||[])).next())}))};const b=e=>{if(!e)return"";return((new DOMParser).parseFromString(e,"text/html").body.textContent||"").replace(/[\s\u00A0\u200B]+/g," ").trim()},R=(e,r)=>{const t=b(e);return t.length<r?"***":t},I=(e,r,t)=>{const o=b(e.NAMN||"")||t,n=r&&o!==t?(e=>{const r=R(e,3);return"***"===r?r:r.split(" ").filter(Boolean).map((e=>`${e.charAt(0)}${"*".repeat(Math.min(3,e.length-1))}`)).join(" ")})(o):o,a=b(e.BOSTADR||""),s=r&&a?(e=>{const r=R(e,3);return"***"===r?r:`${r.substring(0,2)}${"*".repeat(Math.min(5,r.length-2))}`})(a):a,i=b(e.POSTNR||"").replace(/\s+/g,""),l=b(e.POSTADR||""),c=b(e.ORGNR||"");return[n,s,i&&l?`${i} ${l}`:i||l].filter(Boolean).join(", ")+(c?` (${c})`:"")},M=(e,r)=>{const t=null==r?void 0:r.trim();return t?`${e} (${t})`:e},E=(e,r)=>`${e}_${r}`,S=(e,r)=>{try{const o=new URL(e);return!(e=>{const r=e.toLowerCase();return"localhost"===r||"127.0.0.1"===r||"::1"===r||"[::1]"===r||/^10\./.test(r)||/^172\.(1[6-9]|2[0-9]|3[0-1])\./.test(r)||/^192\.168\./.test(r)})(o.hostname)&&(e=>"https:"===e.protocol&&(""===e.port||"443"===e.port))(o)&&(t=o.pathname,/\/(MapServer|FeatureServer)\/\d+(\/query)?$/.test(t))&&((e,r)=>!r||0===r.length||r.some((r=>e===r||e.endsWith("."+r))))(o.hostname,r)}catch(e){return!1}var t},A=(e,r="Invalid FNR: must be a safe integer")=>{if("number"==typeof e){if(!Number.isFinite(e)||!Number.isSafeInteger(e)||e<0)throw new Error(r);return`FNR = ${e}`}const t=String(e).replace(/'/g,"''");if(!t.trim())throw new Error("Invalid FNR: cannot be empty or whitespace-only");return`FNR = '${t}'`},x=e=>{if(!e)return null;return e.FNR||e.fnr||null},j=e=>null!=e?String(e):"",O=e=>"AbortError"===(null==e?void 0:e.name)||"string"==typeof(null==e?void 0:e.message)&&e.message.toLowerCase().includes("abort"),k=(e,r)=>{var t;return e?"string"==typeof e?e:(null===(t=e.details)||void 0===t?void 0:t.message)||e.message||r:r},T=e=>{var r,t,o,n,a;if(!e)return null;const s=null===(t=null===(r=e.getLayerDefinition)||void 0===r?void 0:r.call(e))||void 0===t?void 0:t.url;if(s)return s;const i=null===(n=null===(o=e.getDataSourceJson)||void 0===o?void 0:o.call(e))||void 0===n?void 0:n.url;return i||((null==e?void 0:e.url)||(null===(a=null==e?void 0:e.layer)||void 0===a?void 0:a.url)||null)},D=(e,r,t)=>({valid:!1,error:{type:e,message:r},failureReason:t}),F=e=>null!==e&&"function"==typeof e.query,N=(e,r)=>{var t;const o=null===(t=e.features)||void 0===t?void 0:t[0];if(!(null==o?void 0:o.attributes)||!(null==o?void 0:o.geometry))return null;const n=r(o.attributes);return n?{fnr:n,attrs:o.attributes,graphic:o}:null},_=e=>m(void 0,void 0,void 0,(function*(){const{batch:r,config:o,dsManager:n,maxResults:a,currentRowCount:s,signal:i,helpers:l,messages:c}=e,[u]=yield(0,t.loadArcGISJSAPIModules)(["esri/core/promiseUtils"]),d=yield u.eachAlways(r.map((e=>(e=>m(void 0,void 0,void 0,(function*(){const{fnr:r,config:t,dsManager:o,signal:n,helpers:a}=e;try{if(null==n?void 0:n.aborted)throw new DOMException("Aborted","AbortError");return{ownerFeatures:yield a.queryOwnerByFnr(r,t.ownerDataSourceId,o,{signal:n}),queryFailed:!1}}catch(e){if(a.isAbortError(e))throw e instanceof Error?e:new Error(String(e));return{ownerFeatures:[],queryFailed:!0}}})))({fnr:e.fnr,config:{ownerDataSourceId:o.ownerDataSourceId},dsManager:n,signal:i,helpers:{queryOwnerByFnr:l.queryOwnerByFnr,isAbortError:l.isAbortError}}).then((r=>Object.assign(Object.assign({},r),{validated:e})))))),p=[],g=[];for(const e of d){if(e.error){l.isAbortError(e.error)||console.log("Owner query failed for batch item:",e.error);continue}const{validated:r,ownerFeatures:t,queryFailed:n}=e.value;if(s+p.length>=a)break;const i=C({fnr:r.fnr,propertyAttrs:r.attrs,ownerFeatures:t,queryFailed:n,propertyGraphic:r.graphic,config:{enablePIIMasking:o.enablePIIMasking},helpers:{createRowId:l.createRowId,formatPropertyWithShare:l.formatPropertyWithShare,formatOwnerInfo:l.formatOwnerInfo},messages:c}),u=a-(s+p.length),d=i.slice(0,u);p.push(...d),d.length>0&&g.push({graphic:r.graphic,fnr:r.fnr})}return{rows:p,graphics:g}})),P=e=>({id:e.createRowId(e.fnr,e.objectId),FNR:e.fnr,UUID_FASTIGHET:e.uuidFastighet,FASTIGHET:e.fastighet,BOSTADR:e.bostadr,graphic:e.graphic}),C=e=>{const{fnr:r,propertyAttrs:t,ownerFeatures:o,queryFailed:n,propertyGraphic:a,config:s,helpers:i,messages:l}=e;return o.length>0?o.map((e=>{const t=e.attributes;return P({fnr:r,objectId:t.OBJECTID,uuidFastighet:t.UUID_FASTIGHET,fastighet:i.formatPropertyWithShare(t.FASTIGHET,t.ANDEL||""),bostadr:i.formatOwnerInfo(t,s.enablePIIMasking,l.unknownOwner),graphic:a,createRowId:i.createRowId})})):[P({fnr:r,objectId:t.OBJECTID,uuidFastighet:t.UUID_FASTIGHET,fastighet:t.FASTIGHET,bostadr:n?l.errorOwnerQueryFailed:l.errorNoDataAvailable,graphic:a,createRowId:i.createRowId})]};var L=function(e,r,t,o){return new(t||(t=Promise))((function(n,a){function s(e){try{l(o.next(e))}catch(e){a(e)}}function i(e){try{l(o.throw(e))}catch(e){a(e)}}function l(e){var r;e.done?n(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,i)}l((o=o.apply(e,r||[])).next())}))};const G=(e,r)=>`${e}:${JSON.stringify(r)}`,z=(e,r,t)=>{const o=Date.now(),n=e.get(r);if(n&&o-n.timestamp<300)return n.promise;const a=t().catch((e=>{throw e instanceof Error?e:new Error(String(e))})).finally((()=>{setTimeout((()=>e.delete(r)),300)}));return e.set(r,{promise:a,timestamp:o}),a},V=(e,r,t,o)=>L(void 0,void 0,void 0,(function*(){const n=G("owner",{fnr:String(e),dsId:r});return z(f,n,(()=>L(void 0,void 0,void 0,(function*(){var n,a;try{if(null===(n=null==o?void 0:o.signal)||void 0===n?void 0:n.aborted){const e=new Error("AbortError");throw e.name="AbortError",e}const s=t.getDataSource(r);if(!s)throw new Error("Owner data source not found");const i=yield s.query({where:A(e),returnGeometry:!1,outFields:["*"]});if(null===(a=null==o?void 0:o.signal)||void 0===a?void 0:a.aborted){const e=new Error("AbortError");throw e.name="AbortError",e}return(null==i?void 0:i.records)?i.records.map((e=>e.getData())):[]}catch(e){if(O(e))throw e;throw new Error(k(e,"Owner query failed"))}}))))})),B=()=>{h.clear(),f.clear()},W=()=>{try{if("undefined"==typeof window)return!1;if(!0===(null===navigator||void 0===navigator?void 0:navigator.globalPrivacyControl))return!1;const e=(null===navigator||void 0===navigator?void 0:navigator.doNotTrack)||(null===window||void 0===window?void 0:window.doNotTrack)||(null===navigator||void 0===navigator?void 0:navigator.msDoNotTrack);if("1"===e||"yes"===e)return!1;if(("undefined"!=typeof document&&document.cookie||"").includes("esri_disallow_tracking=1"))return!1;const r=window.localStorage?window.localStorage.getItem("esri_allow_tracking"):null;return"false"!==r&&"true"===r}catch(e){return!1}},U=e=>{if(W())try{console.log("[Property Widget Telemetry]",e)}catch(e){console.log("Telemetry tracking failed",e)}},H=e=>{if(W())try{U({category:"Performance",action:e.operation,label:e.success?"success":"failure",value:Math.round(e.duration)}),e.error&&U({category:"Error",action:e.operation,label:e.error})}catch(e){console.log("Performance tracking failed",e)}},q=(e,r,t)=>{var o;if(W())try{const n="string"==typeof r?r:(null==r?void 0:r.message)||(null===(o=null==r?void 0:r.details)||void 0===o?void 0:o.message)||"Unknown error";U({category:"Error",action:e,label:t?`${n}: ${t}`:n})}catch(e){console.log("Error tracking failed",e)}},$=(e,r)=>{W()&&U({category:"Feature",action:e,label:r?"enabled":"disabled"})};var Q=s(1688),Y=s.n(Q),J=function(e,r,t,o){return new(t||(t=Promise))((function(n,a){function s(e){try{l(o.next(e))}catch(e){a(e)}}function i(e){try{l(o.throw(e))}catch(e){a(e)}}function l(e){var r;e.done?n(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,i)}l((o=o.apply(e,r||[])).next())}))};const Z=e=>{const{graphicsToAdd:r,selectedRows:t,getCurrentView:o,helpers:n,highlightColor:a,outlineWidth:s}=e,i=o();if(!i)return void console.log("syncSelectionGraphics: no active view, deferring graphics sync");const l=(e=>{const{graphicsToAdd:r,selectedRows:t,view:o,helpers:n,highlightColor:a,outlineWidth:s}=e;if(!o)return console.log("syncGraphicsWithState: view is null or undefined, cannot sync graphics"),!1;const i=new Set(t.map((e=>n.normalizeFnrKey(e.FNR))));return r.forEach((({graphic:e,fnr:r})=>{const t=n.normalizeFnrKey(r);i.has(t)&&n.addGraphicsToMap(e,o,n.extractFnr,n.normalizeFnrKey,a,s)})),!0})({graphicsToAdd:r,selectedRows:t,view:i,helpers:n,highlightColor:a,outlineWidth:s});l||console.log("syncSelectionGraphics: failed to sync graphics with state")};class K extends r.React.Component{constructor(e){super(e),this.state={hasError:!1,error:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,r){console.log(this.props.translate("errorBoundaryConsoleLog"),e,r),q("error_boundary",e,r.componentStack)}render(){return this.state.hasError?(0,r.jsx)("div",{css:this.props.styles.errorWrap},(0,r.jsx)(o.Alert,{type:"error",withIcon:!0,text:this.props.translate("errorBoundaryMessage")}),this.state.error&&(0,r.jsx)("div",{css:this.props.styles.errorHint},this.state.error.message)):this.props.children}}const X=n=>{const{config:a,id:s,useMapWidgetIds:i}=n,l=u(),c=r.hooks.useTranslation(),{modules:f,loading:b,error:R}=(()=>{const[e,o]=r.React.useState(null),[n,a]=r.React.useState(!0),[s,i]=r.React.useState(null);return r.hooks.useEffectOnce((()=>{const e=null===globalThis||void 0===globalThis?void 0:globalThis.__ESRI_TEST_STUB__;y(void 0,void 0,void 0,"function"!=typeof e?function*(){try{const e=yield(0,t.loadArcGISJSAPIModules)(d.slice()),[r,n,a]=e;o({SimpleFillSymbol:r,Graphic:n,GraphicsLayer:a})}catch(e){i(e)}finally{a(!1)}}:function*(){try{const r=yield Promise.resolve(e(d));o(r)}catch(e){i(e)}finally{a(!1)}})})),{modules:e,loading:n,error:s}})(),{ensureGraphicsLayer:A,clearGraphics:P,removeGraphicsForFnr:C,addGraphicsToMap:W,destroyGraphicsLayer:Q}=w(f,s),{disablePopup:K,restorePopup:X}=(()=>{const e=r.React.useRef(new Map),t=r.hooks.useEventCallback((r=>{if(!r)return;const t=r.popup,o=e.current.get(r);t&&void 0!==o&&(t.autoOpenEnabled=o,e.current.delete(r))})),o=r.hooks.useEventCallback((r=>{if(!r)return;const t=r.popup;t&&"boolean"==typeof t.autoOpenEnabled&&(e.current.has(r)||e.current.set(r,t.autoOpenEnabled),t.autoOpenEnabled=!1)})),n=r.hooks.useEventCallback((e=>{t(e)}));return{disablePopup:o,restorePopup:t,cleanup:n}})(),{getController:ee,releaseController:re,abortAll:te}=(()=>{const e=r.React.useRef([]),t=r.React.useRef(new Set),o=r.hooks.useEventCallback((()=>{let r=e.current.pop();for(;r&&r.signal.aborted;)r=e.current.pop();const o=r||new AbortController;return t.current.add(o),o})),n=r.hooks.useEventCallback((r=>{t.current.delete(r),r.signal.aborted||e.current.length<10&&e.current.push(r)})),a=r.hooks.useEventCallback((()=>{t.current.forEach((e=>{e.signal.aborted||e.abort()})),t.current.clear(),e.current=[]}));return r.hooks.useUnmount((()=>{a()})),{getController:o,releaseController:n,abortAll:a}})(),oe=r.React.useRef(null);oe.current||(oe.current=r.DataSourceManager.getInstance());const ne=r.React.useRef(0),[ae,se]=r.React.useState({loading:!1,error:null,selectedProperties:[]}),ie=a.maxResults,le=a.enableToggleRemoval,ce=a.enablePIIMasking,ue=null==i?void 0:i[0],de=r.hooks.useEventCallback((e=>{C(e,j),se((r=>{const t=[],o=[];return r.selectedProperties.forEach((r=>{r.FNR!==e?o.push(r):t.push(r)})),0===t.length?r:(U({category:"Property",action:"remove",value:t.length}),Object.assign(Object.assign({},r),{selectedProperties:o}))}))})),pe=r.hooks.useEventCallback((()=>{te(),B(),P(),se((e=>(U({category:"Property",action:"clear_all",value:e.selectedProperties.length}),Object.assign(Object.assign({},e),{selectedProperties:[],error:null}))))})),ge=r.hooks.useEventCallback(((e,r,t)=>{se((o=>Object.assign(Object.assign({},o),{loading:!1,error:{type:e,message:r,details:t}})))})),ve=r.hooks.useEventCallback((r=>J(void 0,void 0,void 0,(function*(){te();const t=(e=>{const r=performance.now();return{success:()=>{const t=performance.now()-r;H({operation:e,duration:t,success:!0})},failure:t=>{const o=performance.now()-r;H({operation:e,duration:o,success:!1,error:t})}}})("map_click_query"),o=((e,r,t,o)=>r?(null==e?void 0:e.mapPoint)?{valid:!0,mapPoint:e.mapPoint}:{valid:!1,error:{type:"GEOMETRY_ERROR",message:o("errorNoMapPoint")}}:{valid:!1,error:{type:"VALIDATION_ERROR",message:o("errorLoadingModules")}})(r,f,0,c);if(!o.valid){const{error:e}=o;return ge(e.type,e.message),t.failure(e.type),void q("map_click_validation",e.type,e.message)}const{mapPoint:n}=o,s=(e=>{const{propertyDsId:r,ownerDsId:t,dsManager:o,allowedHosts:n,translate:a}=e;if(!r||!t)return D("VALIDATION_ERROR",a("errorNoDataAvailable"),"missing_data_sources");if(!o)return D("QUERY_ERROR",a("errorQueryFailed"),"no_data_source_manager");const s=o.getDataSource(r),i=o.getDataSource(t);if(!s||!i)return D("VALIDATION_ERROR",a("errorNoDataAvailable"),"missing_data_source_instance");if(!F(s))return D("VALIDATION_ERROR",a("errorNoDataAvailable"),"property_ds_not_queryable");if(!F(i))return D("VALIDATION_ERROR",a("errorNoDataAvailable"),"owner_ds_not_queryable");const l=null==n?void 0:n.map((e=>e.trim())).filter((e=>e.length>0)),c=T(s);if(!c||!S(c,l))return D("VALIDATION_ERROR",a("errorHostNotAllowed"),"property_disallowed_host");const u=T(i);return u&&S(u,l)?{valid:!0,manager:o}:D("VALIDATION_ERROR",a("errorHostNotAllowed"),"owner_disallowed_host")})({propertyDsId:a.propertyDataSourceId,ownerDsId:a.ownerDataSourceId,dsManager:oe.current,allowedHosts:a.allowedHosts,translate:c});if((e=>!e.valid)(s)){const{error:e,failureReason:r}=s;return ge(e.type,e.message),t.failure(r),void q("map_click",r)}const{manager:i}=s,l=ne.current+1;ne.current=l;const u=()=>l!==ne.current;se((e=>Object.assign(Object.assign({},e),{loading:!0,error:null})));const d=ee();try{const e=yield(g=n,y=a.propertyDataSourceId,w=i,b={signal:d.signal},L(void 0,void 0,void 0,(function*(){var e;const r=G("property",{x:Math.round(100*g.x)/100,y:Math.round(100*g.y)/100,wkid:null===(e=g.spatialReference)||void 0===e?void 0:e.wkid,dsId:y});return z(h,r,(()=>L(void 0,void 0,void 0,(function*(){var e,r;try{if(null===(e=null==b?void 0:b.signal)||void 0===e?void 0:e.aborted){const e=new Error("AbortError");throw e.name="AbortError",e}const t=w.getDataSource(y);if(!t)throw new Error("Property data source not found");const o=yield t.query({geometry:g,returnGeometry:!0,outFields:["*"],spatialRel:"esriSpatialRelIntersects"});if(null===(r=null==b?void 0:b.signal)||void 0===r?void 0:r.aborted){const e=new Error("AbortError");throw e.name="AbortError",e}return(null==o?void 0:o.records)?o.records.map((e=>{const r=e.getData();return{features:[r],propertyId:r.attributes.FNR}})):[]}catch(e){if(O(e))throw e;throw new Error(k(e,"Property query failed"))}}))))})));if(d.signal.aborted||u()){if(u())return;return se((e=>Object.assign(Object.assign({},e),{loading:!1}))),void t.failure("aborted")}if(!e.length){if(u())return;return se((e=>Object.assign(Object.assign({},e),{loading:!1}))),t.success(),void U({category:"Query",action:"property_query",label:"no_results"})}const{rowsToProcess:r,graphicsToAdd:o}=yield(p={propertyResults:e,config:{ownerDataSourceId:a.ownerDataSourceId,enablePIIMasking:ce},dsManager:i,maxResults:ie,signal:d.signal,helpers:{extractFnr:x,queryOwnerByFnr:V,createRowId:E,formatPropertyWithShare:M,formatOwnerInfo:I,isAbortError:O},messages:{unknownOwner:c("unknownOwner"),errorOwnerQueryFailed:c("errorOwnerQueryFailed"),errorNoDataAvailable:c("errorNoDataAvailable")}},m(void 0,void 0,void 0,(function*(){const{propertyResults:e,config:r,dsManager:t,maxResults:o,helpers:n,messages:a,signal:s}=p,i=[],l=[],c=new Set,u=[];for(const r of e){const e=N(r,n.extractFnr);e&&!c.has(e.fnr)&&(c.add(e.fnr),u.push(e))}for(let e=0;e<u.length;){const c=o-l.length;if(c<=0)break;const d=Math.min(c,5,u.length-e),p=u.slice(e,e+d),{rows:g,graphics:v}=yield _({batch:p,config:{ownerDataSourceId:r.ownerDataSourceId,enablePIIMasking:r.enablePIIMasking},dsManager:t,maxResults:o,currentRowCount:l.length,signal:s,helpers:{queryOwnerByFnr:n.queryOwnerByFnr,isAbortError:n.isAbortError,createRowId:n.createRowId,formatPropertyWithShare:n.formatPropertyWithShare,formatOwnerInfo:n.formatOwnerInfo},messages:a});l.push(...g),i.push(...v),e+=d}return{rowsToProcess:l,graphicsToAdd:i}})));if(d.signal.aborted||u()){if(u())return;return se((e=>Object.assign(Object.assign({},e),{loading:!1}))),void t.failure("aborted")}let s=null,l=null;if(u())return;se((e=>{if(u())return e;const{updatedRows:t,toRemove:n}=((e,r,t,o)=>{const n=new Set,a=[],s=new Set(r.map((e=>j(e.FNR)))),i=new Set(r.map((e=>e.id))),l=new Set,c=new Set;for(const r of e){const e=j(r.FNR);t&&s.has(e)&&!c.has(e)?(n.add(e),c.add(e)):i.has(r.id)||l.has(r.id)||(a.push(r),l.add(r.id))}const u=[...r.filter((e=>!n.has(j(e.FNR)))),...a];return u.length>o&&(u.length=o),{toRemove:n,toAdd:a,updatedRows:u}})(r,e.selectedProperties,le,ie);if(s={updatedRows:t,previousRows:e.selectedProperties},l={graphicsToAdd:o,selectedRows:t,getCurrentView:ye,helpers:{addGraphicsToMap:W,extractFnr:x,normalizeFnrKey:j},highlightColor:v,outlineWidth:2},n.size>0){const r=e.selectedProperties.filter((e=>n.has(j(e.FNR))));r.length>0&&U({category:"Property",action:"toggle_remove",value:r.length})}return Object.assign(Object.assign({},e),{loading:!1,selectedProperties:t})})),s&&(e=>{const{updatedRows:r,previousRows:t,removeGraphicsForFnr:o,normalizeFnrKey:n}=e,a=new Set(r.map((e=>n(e.FNR))));t.forEach((e=>{const r=n(e.FNR);a.has(r)||o(e.FNR,n)}))})({updatedRows:s.updatedRows,previousRows:s.previousRows,removeGraphicsForFnr:C,normalizeFnrKey:j}),l&&Z(l),t.success(),U({category:"Query",action:"property_query",label:"success",value:r.length}),$("pii_masking",ce),$("toggle_removal",le)}catch(r){if(u())return;if(O(r))return se((e=>Object.assign(Object.assign({},e),{loading:!1}))),void t.failure("aborted");ge(e.QUERY_ERROR,c("errorQueryFailed")),t.failure("query_error"),q("property_query",r)}finally{re(d)}var p,g,y,w,b})))),he=(e=>{const[o,n]=r.React.useState(null),[a,s]=r.React.useState(null);return r.hooks.useEffectOnce((()=>{(0,t.loadArcGISJSAPIModules)(["esri/core/promiseUtils"]).then((([e])=>{s(e)}))})),r.hooks.useUpdateEffect((()=>{a&&e&&n((()=>a.debounce(e)))}),[a,e]),o||e})(ve),{onActiveViewChange:fe,getCurrentView:ye}=(e=>{const{modules:t,ensureGraphicsLayer:o,destroyGraphicsLayer:n,disablePopup:a,restorePopup:s,onMapClick:i}=e,l=r.React.useRef(null),c=r.React.useRef(null),u=r.hooks.useEventCallback((e=>{a(e),o(e),c.current&&c.current.remove(),c.current=e.on("click",i)})),d=r.hooks.useEventCallback((()=>{var e;const r=null===(e=l.current)||void 0===e?void 0:e.view;r&&(s(r),n(r))})),p=r.hooks.useEventCallback((e=>{var r;if(!t)return;const o=null==e?void 0:e.view;if(!o)return;const n=null===(r=l.current)||void 0===r?void 0:r.view;n&&n!==o&&d(),l.current=e,u(o)})),g=r.hooks.useEventCallback((()=>{var e;const r=null===(e=l.current)||void 0===e?void 0:e.view;s(r),c.current&&(c.current.remove(),c.current=null),r&&n(r)}));return r.hooks.useUnmount((()=>{g()})),{onActiveViewChange:p,getCurrentView:()=>{var e;return null===(e=l.current)||void 0===e?void 0:e.view},cleanup:g}})({modules:f,ensureGraphicsLayer:A,destroyGraphicsLayer:Q,disablePopup:K,restorePopup:X,onMapClick:he});return r.hooks.useUnmount((()=>{te(),B()})),b?(0,r.jsx)("div",{css:l.parent,role:"region","aria-label":c("widgetTitle")},(0,r.jsx)("div",{css:l.loading,role:"status","aria-live":"polite","aria-busy":"true"},(0,r.jsx)(o.Loading,{type:o.LoadingType.Donut}),(0,r.jsx)("div",null,c("loadingModules")))):R?(0,r.jsx)("div",{css:l.parent,role:"region","aria-label":c("widgetTitle")},(0,r.jsx)("div",{css:l.error,role:"alert","aria-live":"assertive"},(0,r.jsx)(o.Alert,{type:"error",withIcon:!0,text:c("errorLoadingModules")}))):(0,r.jsx)("div",{css:l.parent,role:"region","aria-label":c("widgetTitle")},(0,r.jsx)("div",{css:l.header},(0,r.jsx)("div",{css:l.buttons},(0,r.jsx)(o.Button,{type:"tertiary",icon:!0,onClick:pe,title:c("clearAll"),disabled:0===ae.selectedProperties.length}," ",(0,r.jsx)(o.SVG,{src:Y()})))),(0,r.jsx)("div",{css:l.cols},(0,r.jsx)("div",{css:l.col},c("columnFastighet")),(0,r.jsx)("div",{css:l.col},c("columnOwner"))),(0,r.jsx)("div",{css:l.body,role:"main"},ae.loading&&(0,r.jsx)("div",{css:l.loading,role:"status","aria-live":"polite","aria-busy":"true"},(0,r.jsx)(o.Loading,{type:o.LoadingType.Donut}),(0,r.jsx)("div",null,c("loadingData"))),ae.error&&(0,r.jsx)("div",{css:l.error,role:"alert","aria-live":"assertive"},(0,r.jsx)(o.Alert,{type:"error",withIcon:!0,text:ae.error.message}),ae.error.details&&(0,r.jsx)("div",null,ae.error.details)),!ae.loading&&!ae.error&&ae.selectedProperties.length>0&&(0,r.jsx)("div",{css:l.list,role:"list","aria-label":c("widgetTitle")},ae.selectedProperties.map((e=>(0,r.jsx)("div",{css:l.row,role:"listitem",key:e.id},(0,r.jsx)("div",{css:l.column,"data-column":p},e.FASTIGHET),(0,r.jsx)("div",{css:l.column,"data-column":g},e.BOSTADR),(0,r.jsx)("div",{css:l.actions},(0,r.jsx)(o.Button,{type:"tertiary",size:"sm",onClick:()=>de(e.FNR),"aria-label":`${c("removeProperty")} ${e.FASTIGHET}`},c("removeProperty")))))))),(0,r.jsx)("div",{css:l.footer},(0,r.jsx)("div",{css:l.col},c("propertySelected")),(0,r.jsx)("div",{css:l.col},ae.selectedProperties.length)),ue&&(0,r.jsx)(t.JimuMapViewComponent,{useMapWidgetId:ue,onActiveViewChange:fe}))},ee=e=>{const t=u(),o=r.hooks.useTranslation();return(0,r.jsx)(K,{styles:t,translate:o},(0,r.jsx)(X,Object.assign({},e)))};function re(e){s.p=e}})(),i})())}}}));