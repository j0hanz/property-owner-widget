System.register(["jimu-core","jimu-arcgis","jimu-ui","jimu-theme"],(function(e,r){var o={},t={},n={},a={};return{setters:[function(e){o.DataSourceManager=e.DataSourceManager,o.React=e.React,o.css=e.css,o.hooks=e.hooks,o.jsx=e.jsx},function(e){t.JimuMapViewComponent=e.JimuMapViewComponent,t.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules},function(e){n.Alert=e.Alert,n.Button=e.Button,n.Loading=e.Loading,n.LoadingType=e.LoadingType},function(e){a.useTheme=e.useTheme}],execute:function(){e((()=>{var e={1888:e=>{"use strict";e.exports=a},2686:e=>{"use strict";e.exports=t},4321:e=>{"use strict";e.exports=n},9244:e=>{"use strict";e.exports=o}},r={};function i(o){var t=r[o];if(void 0!==t)return t.exports;var n=r[o]={exports:{}};return e[o](n,n.exports,i),n.exports}i.d=(e,r)=>{for(var o in r)i.o(r,o)&&!i.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:r[o]})},i.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.p="";var s={};return i.p=window.jimuConfig.baseUrl,(()=>{"use strict";i.r(s),i.d(s,{__set_webpack_public_path__:()=>K,default:()=>J});var e,r=i(9244),o=i(2686),t=i(4321);!function(e){e.QUERY_ERROR="QUERY_ERROR",e.NETWORK_ERROR="NETWORK_ERROR",e.VALIDATION_ERROR="VALIDATION_ERROR",e.GEOMETRY_ERROR="GEOMETRY_ERROR"}(e||(e={}));var n=i(1888);const a=e=>{var r;return{fontFamily:null==e?void 0:e.fontFamily,fontWeight:null===(r=null==e?void 0:e.fontWeight)||void 0===r?void 0:r.toString(),fontSize:null==e?void 0:e.fontSize,fontStyle:null==e?void 0:e.fontStyle,lineHeight:null==e?void 0:e.lineHeight,color:null==e?void 0:e.color}},l=(e,o={})=>(0,r.css)(Object.assign({display:"flex",flexFlow:"column"===e?"column nowrap":"row nowrap"},o)),c=(e,r={})=>l(e,Object.assign({flex:"0 0 auto"},r)),u=()=>(e=>{var o,t,n,i,s,u;const d=e.sys.spacing,p=e.sys.color,g=e.sys.typography;return{parent:l("column",{flex:"1 1 auto",overflowY:"auto",blockSize:"100%",gap:null==d?void 0:d(2),backgroundColor:null===(o=null==p?void 0:p.surface)||void 0===o?void 0:o.paper}),header:c("row",{alignItems:"center",justifyContent:"space-between",padding:null==d?void 0:d(1)}),cols:c("row",{borderBlockStart:`1px solid ${null===(t=null==p?void 0:p.divider)||void 0===t?void 0:t.primary}`,borderBlockEnd:`1px solid ${null===(n=null==p?void 0:p.divider)||void 0===n?void 0:n.primary}`}),col:(0,r.css)({flex:"1 1 0",display:"flex",justifyContent:"center",padding:null==d?void 0:d(1)}),body:l("column",{flex:"1 1 0",overflow:"auto"}),list:c("column"),row:c("row",{gap:null==d?void 0:d(2),padding:null==d?void 0:d(1),borderBlockEnd:`1px solid ${null===(i=null==p?void 0:p.divider)||void 0===i?void 0:i.secondary}`,alignItems:"center"}),column:(0,r.css)({flex:"1 1 0",minWidth:0}),actions:c("row",{alignItems:"center"}),loading:(0,r.css)({padding:null==d?void 0:d(1.5)}),error:(0,r.css)({padding:null==d?void 0:d(1.5)}),errorWrap:l("column",{flex:"1 1 auto",gap:null==d?void 0:d(1),padding:null==d?void 0:d(2)}),errorHint:(0,r.css)({color:null===(s=null==p?void 0:p.surface)||void 0===s?void 0:s.backgroundHint}),buttons:c("row",{gap:null==d?void 0:d(1)}),footer:c("row",Object.assign({borderBlockStart:`1px solid ${null===(u=null==p?void 0:p.divider)||void 0===u?void 0:u.primary}`},a(null==g?void 0:g.label2)))}})((0,n.useTheme)()),d=["esri/symbols/SimpleFillSymbol","esri/Graphic","esri/layers/GraphicsLayer"],p="FASTIGHET",g="BOSTADR",v=[0,180,216,.4],h=new Map,f=new Map;var y=function(e,r,o,t){return new(o||(o=Promise))((function(n,a){function i(e){try{l(t.next(e))}catch(e){a(e)}}function s(e){try{l(t.throw(e))}catch(e){a(e)}}function l(e){var r;e.done?n(e.value):(r=e.value,r instanceof o?r:new o((function(e){e(r)}))).then(i,s)}l((t=t.apply(e,r||[])).next())}))};const m=(e,o)=>{const t=r.React.useRef(null),n=r.React.useRef(new Map),a=r.hooks.useEventCallback((r=>{e&&r&&(t.current?r.map.findLayerById(t.current.id)||r.map.add(t.current):(t.current=new e.GraphicsLayer({id:`${o}-property-highlight-layer`,listMode:"hide"}),r.map.add(t.current)))})),i=r.hooks.useEventCallback((()=>{t.current&&t.current.removeAll(),n.current.clear()})),s=r.hooks.useEventCallback(((e,r)=>{const o=t.current;if(!o)return;const a=r(e),i=n.current.get(a);i&&i.length>0&&(o.removeMany(i),n.current.delete(a))})),l=r.hooks.useEventCallback(((r,o,i,l,c,u)=>{if(!e||!r||!o)return;a(o);const d=t.current;if(!d)return;const p=i(r.attributes||null),g=((r,o)=>e?new e.SimpleFillSymbol({color:r,outline:{color:[r[0],r[1],r[2],1],width:o}}):null)(c,u);if(!g)return;const v=r.clone();if(v.symbol=g,v.attributes=Object.assign(Object.assign({},v.attributes||{}),{FNR:p}),s(p,l),d.add(v),!p)return;const h=l(p),f=n.current.get(h)||[];n.current.set(h,[...f,v])})),c=r.hooks.useEventCallback((e=>{var r;e&&t.current&&(null===(r=e.map)||void 0===r||r.remove(t.current),t.current.destroy(),t.current=null,n.current.clear())}));return r.hooks.useUnmount((()=>{var e,r;t.current&&(null===(r=(e=t.current).destroy)||void 0===r||r.call(e),t.current=null),n.current.clear()})),{graphicsLayerRef:t,graphicsMapRef:n,ensureGraphicsLayer:a,clearGraphics:i,removeGraphicsForFnr:s,addGraphicsToMap:l,destroyGraphicsLayer:c}};var w=function(e,r,o,t){return new(o||(o=Promise))((function(n,a){function i(e){try{l(t.next(e))}catch(e){a(e)}}function s(e){try{l(t.throw(e))}catch(e){a(e)}}function l(e){var r;e.done?n(e.value):(r=e.value,r instanceof o?r:new o((function(e){e(r)}))).then(i,s)}l((t=t.apply(e,r||[])).next())}))};const b=e=>{if(!e)return"";return(new DOMParser).parseFromString(e,"text/html").body.textContent||""},R=(e,r,o)=>{var t,n,a,i,s,l,c,u,d;const p=b((null===(n=null===(t=e.NAMN)||void 0===t?void 0:t.trim)||void 0===n?void 0:n.call(t))||o),g=r&&p!==o?(e=>{const r=b(e),o=(null==r?void 0:r.replace(/[\s\u00A0\u200B]+/g," ").trim())||"";return o.length<3?"***":o.split(" ").map((e=>e.length>0?`${e.charAt(0)}${"*".repeat(Math.min(3,e.length-1))}`:"")).filter(Boolean).join(" ")})(p):p,v=b((null===(i=null===(a=e.BOSTADR)||void 0===a?void 0:a.trim)||void 0===i?void 0:i.call(a))||""),h=r&&v?(e=>{const r=b(e),o=(null==r?void 0:r.replace(/[\s\u00A0\u200B]+/g," ").trim())||"";return o.length<3?"***":`${o.substring(0,2)}${"*".repeat(Math.min(5,o.length-2))}`})(v):v,f=b((null===(s=e.POSTNR)||void 0===s?void 0:s.replace(/\s+/g,""))||""),y=b((null===(c=null===(l=e.POSTADR)||void 0===l?void 0:l.trim)||void 0===c?void 0:c.call(l))||""),m=b((null===(d=null===(u=e.ORGNR)||void 0===u?void 0:u.trim)||void 0===d?void 0:d.call(u))||""),w=m?` (${m})`:"";return[g,h,f&&y?`${f} ${y}`:f||y].filter(Boolean).join(", ")+w},E=(e,r)=>{var o;const t=null===(o=null==r?void 0:r.trim)||void 0===o?void 0:o.call(r);return t?`${e} (${t})`:e},O=(e,r)=>`${e}_${r}`,A=(e,r)=>{try{const o=new URL(e),t=o.hostname.toLowerCase();if("localhost"===t||"127.0.0.1"===t||"::1"===t||"[::1]"===t||/^10\./.test(t)||/^172\.(1[6-9]|2[0-9]|3[0-1])\./.test(t)||/^192\.168\./.test(t))return!1;const n="https:"===o.protocol,a=!o.port||"443"===o.port,i=/\/(MapServer|FeatureServer)\/\d+(\/(query)?)?$/.test(o.pathname),s=!r||0===r.length||r.some((e=>o.hostname===e||o.hostname.endsWith("."+e)));return n&&a&&i&&s}catch(e){return!1}},S=(e,r="Invalid FNR: must be a safe integer")=>{if("number"==typeof e){if(!Number.isFinite(e)||!Number.isSafeInteger(e)||e<0)throw new Error(r);return`FNR = ${e}`}const o=String(e).replace(/'/g,"''");if(0===o.trim().length)throw new Error("Invalid FNR: cannot be empty or whitespace-only");return`FNR = '${o}'`},k=e=>{if(!e)return null;return e.FNR||e.fnr||null},I=e=>null!=e?String(e):"",F=e=>!!e&&("AbortError"===e.name||!("string"!=typeof e.message||!e.message.toLowerCase().includes("abort"))),T=(e,r)=>{var o;return e?"string"==typeof e?e:(null===(o=e.details)||void 0===o?void 0:o.message)?e.details.message:e.message?e.message:r:r},x=e=>{var r,o,t;if(!e)return null;const n=null===(r=e.getLayerDefinition)||void 0===r?void 0:r.call(e),a=n&&"object"==typeof n?n.url:void 0;if("string"==typeof a&&a.length>0)return a;const i=null===(o=e.getDataSourceJson)||void 0===o?void 0:o.call(e),s=i&&"object"==typeof i?i.url:void 0;if("string"==typeof s&&s.length>0)return s;return(null==e?void 0:e.url)||(null===(t=null==e?void 0:e.layer)||void 0===t?void 0:t.url)||null},j=(e,r)=>{var o;const t=null===(o=e.features)||void 0===o?void 0:o[0];if(!(null==t?void 0:t.attributes))return null;if(!t.geometry)return null;const n=t.attributes,a=r(n);return a?{fnr:a,attrs:n,graphic:t}:null},P=e=>w(void 0,void 0,void 0,(function*(){const{batch:r,config:o,dsManager:t,maxResults:n,currentRowCount:a,signal:i,helpers:s,messages:l}=e,c=yield Promise.allSettled(r.map((e=>(e=>w(void 0,void 0,void 0,(function*(){const{fnr:r,config:o,dsManager:t,signal:n,helpers:a}=e;let i=[],s=!1;try{if(null==n?void 0:n.aborted){const e=new Error("AbortError");throw e.name="AbortError",e}i=yield a.queryOwnerByFnr(r,o.ownerDataSourceId,t,{signal:n})}catch(e){if(a.isAbortError(e))throw e instanceof Error?e:new Error(String(e));s=!0}return{ownerFeatures:i,queryFailed:s}})))({fnr:e.fnr,config:{ownerDataSourceId:o.ownerDataSourceId},dsManager:t,signal:i,helpers:{queryOwnerByFnr:s.queryOwnerByFnr,isAbortError:s.isAbortError}}).then((r=>Object.assign(Object.assign({},r),{validated:e,status:"fulfilled"}))).catch((r=>{if(s.isAbortError(r)){throw r instanceof Error?r:new Error(String(r))}return{validated:e,ownerFeatures:[],queryFailed:!0,status:"rejected"}}))))),u=[],d=[];for(const e of c){if("rejected"===e.status){console.log("Owner query failed for batch item:",e.reason);continue}const{validated:r,ownerFeatures:t,queryFailed:i}=e.value;if(a+u.length>=n)break;const c=_({fnr:r.fnr,propertyAttrs:r.attrs,ownerFeatures:t,queryFailed:i,propertyGraphic:r.graphic,config:{enablePIIMasking:o.enablePIIMasking},helpers:{createRowId:s.createRowId,formatPropertyWithShare:s.formatPropertyWithShare,formatOwnerInfo:s.formatOwnerInfo},messages:l}),p=n-(a+u.length),g=c.slice(0,p);u.push(...g),g.length>0&&d.push({graphic:r.graphic,fnr:r.fnr})}return{rows:u,graphics:d}})),_=e=>{const{fnr:r,propertyAttrs:o,ownerFeatures:t,queryFailed:n,propertyGraphic:a,config:i,helpers:s,messages:l}=e;return t.length>0?t.map((e=>{const o=e.attributes;return{id:s.createRowId(r,o.OBJECTID),FNR:r,UUID_FASTIGHET:o.UUID_FASTIGHET,FASTIGHET:s.formatPropertyWithShare(o.FASTIGHET,o.ANDEL||""),BOSTADR:s.formatOwnerInfo(o,i.enablePIIMasking,l.unknownOwner),graphic:a}})):[{id:s.createRowId(r,o.OBJECTID),FNR:r,UUID_FASTIGHET:o.UUID_FASTIGHET,FASTIGHET:o.FASTIGHET,BOSTADR:n?l.errorOwnerQueryFailed:l.errorNoDataAvailable,graphic:a}]};var C=function(e,r,o,t){return new(o||(o=Promise))((function(n,a){function i(e){try{l(t.next(e))}catch(e){a(e)}}function s(e){try{l(t.throw(e))}catch(e){a(e)}}function l(e){var r;e.done?n(e.value):(r=e.value,r instanceof o?r:new o((function(e){e(r)}))).then(i,s)}l((t=t.apply(e,r||[])).next())}))};const D=(e,r)=>`${e}:${JSON.stringify(r)}`,M=(e,r,o)=>{const t=Date.now(),n=e.get(r);if(n&&t-n.timestamp<300)return n.promise;const a=o().catch((o=>{e.delete(r);throw o instanceof Error?o:new Error(String(o))})).finally((()=>{setTimeout((()=>e.delete(r)),300)}));return e.set(r,{promise:a,timestamp:t}),a},N=(e,r,o,t)=>C(void 0,void 0,void 0,(function*(){const n=D("owner",{fnr:String(e),dsId:r});return M(f,n,(()=>C(void 0,void 0,void 0,(function*(){var n,a;try{if(null===(n=null==t?void 0:t.signal)||void 0===n?void 0:n.aborted){const e=new Error("AbortError");throw e.name="AbortError",e}const i=o.getDataSource(r);if(!i)throw new Error("Owner data source not found");const s=yield i.query({where:S(e),returnGeometry:!1,outFields:["*"]});if(null===(a=null==t?void 0:t.signal)||void 0===a?void 0:a.aborted){const e=new Error("AbortError");throw e.name="AbortError",e}return(null==s?void 0:s.records)?s.records.map((e=>e.getData())):[]}catch(e){if(F(e))throw e;throw new Error(T(e,"Owner query failed"))}}))))})),G=()=>{h.clear(),f.clear()},L=()=>{try{if("undefined"==typeof window)return!1;if(!0===(null===navigator||void 0===navigator?void 0:navigator.globalPrivacyControl))return!1;const e=(null===navigator||void 0===navigator?void 0:navigator.doNotTrack)||(null===window||void 0===window?void 0:window.doNotTrack)||(null===navigator||void 0===navigator?void 0:navigator.msDoNotTrack);if("1"===e||"yes"===e)return!1;if(("undefined"!=typeof document&&document.cookie||"").includes("esri_disallow_tracking=1"))return!1;const r=window.localStorage?window.localStorage.getItem("esri_allow_tracking"):null;return"true"===r}catch(e){return!1}},B=e=>{if(L())try{console.log("[Property Widget Telemetry]",e)}catch(e){console.log("Telemetry tracking failed",e)}},H=e=>{if(L())try{B({category:"Performance",action:e.operation,label:e.success?"success":"failure",value:Math.round(e.duration)}),e.error&&B({category:"Error",action:e.operation,label:e.error})}catch(e){console.log("Performance tracking failed",e)}},q=(e,r,o)=>{var t;if(L())try{const n="string"==typeof r?r:(null==r?void 0:r.message)||(null===(t=null==r?void 0:r.details)||void 0===t?void 0:t.message)||"Unknown error";B({category:"Error",action:e,label:o?`${n}: ${o}`:n})}catch(e){console.log("Error tracking failed",e)}},U=(e,r)=>{L()&&B({category:"Feature",action:e,label:r?"enabled":"disabled"})},$={widgetTitle:"Property Owner",description:"Retrieve property ownership information",loading:"Loading...",loadingData:"Retrieving property data...",loadingModules:"Loading map modules...",queryingProperty:"Searching property...",queryingOwner:"Retrieving owner information...",noResults:"No properties found",propertySelected:"Properties selected:",multipleOwnersFound:"Multiple owners found",columnFastighet:"Property",columnOwner:"Owner & Address",actions:"Actions",errorTitle:"Error",errorModuleTitle:"Module Error",errorLoadingModules:"Could not load required map modules",errorNoMapPoint:"Could not read map coordinates",errorQueryFailed:"Could not retrieve property data",errorOwnerQueryFailed:"Could not retrieve owner information",errorNetworkError:"Network error. Check your connection",errorNoDataAvailable:"No data available",errorHostNotAllowed:"Selected data source host is not allowed",errorUnknown:"An unknown error occurred",unknownOwner:"Unknown owner",removeProperty:"Remove property",clearAll:"Clear all",undo:"Undo",undoLastAction:"Undo last action",close:"Close",invalidHexColorFormat:"Invalid hex color format",ownerQueryFailedLog:"Owner query failed",unknownErrorLog:"Unknown error",invalidFnrError:"Invalid FNR: must be a safe integer",unknownErrorGeneric:"An unknown error occurred",errorBoundaryMessage:"Widget error. Please refresh the page.",errorBoundaryConsoleLog:"Property widget error:"};var W=function(e,r,o,t){return new(o||(o=Promise))((function(n,a){function i(e){try{l(t.next(e))}catch(e){a(e)}}function s(e){try{l(t.throw(e))}catch(e){a(e)}}function l(e){var r;e.done?n(e.value):(r=e.value,r instanceof o?r:new o((function(e){e(r)}))).then(i,s)}l((t=t.apply(e,r||[])).next())}))};const V=e=>{const{graphicsToAdd:r,selectedRows:o,getCurrentView:t,helpers:n,highlightColor:a,outlineWidth:i}=e,s=t();if(!s)return void console.log("syncSelectionGraphics: no active view, deferring graphics sync");const l=(e=>{const{graphicsToAdd:r,selectedRows:o,view:t,helpers:n,highlightColor:a,outlineWidth:i}=e;if(!t)return console.log("syncGraphicsWithState: view is null or undefined, cannot sync graphics"),!1;const s=new Set(o.map((e=>n.normalizeFnrKey(e.FNR))));return r.forEach((({graphic:e,fnr:r})=>{const o=n.normalizeFnrKey(r);s.has(o)&&n.addGraphicsToMap(e,t,n.extractFnr,n.normalizeFnrKey,a,i)})),!0})({graphicsToAdd:r,selectedRows:o,view:s,helpers:n,highlightColor:a,outlineWidth:i});l||console.log("syncSelectionGraphics: failed to sync graphics with state")};class Q extends r.React.Component{constructor(e){super(e),this.state={hasError:!1,error:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,r){console.log(this.props.translate("errorBoundaryConsoleLog"),e,r),q("error_boundary",e,r.componentStack)}render(){return this.state.hasError?(0,r.jsx)("div",{css:this.props.styles.errorWrap},(0,r.jsx)(t.Alert,{type:"error",withIcon:!0,text:this.props.translate("errorBoundaryMessage")}),this.state.error&&(0,r.jsx)("div",{css:this.props.styles.errorHint},this.state.error.message)):this.props.children}}const z=n=>{const{config:a,id:i,useMapWidgetIds:s}=n,l=u(),c=r.hooks.useTranslation($),{modules:f,loading:b,error:S}=(()=>{const[e,t]=r.React.useState(null),[n,a]=r.React.useState(!0),[i,s]=r.React.useState(null);return r.hooks.useEffectOnce((()=>{const e=null===globalThis||void 0===globalThis?void 0:globalThis.__ESRI_TEST_STUB__;y(void 0,void 0,void 0,"function"!=typeof e?function*(){try{const e=yield(0,o.loadArcGISJSAPIModules)(d.slice()),[r,n,a]=e;t({SimpleFillSymbol:r,Graphic:n,GraphicsLayer:a})}catch(e){s(e)}finally{a(!1)}}:function*(){try{const r=yield Promise.resolve(e(d));t(r)}catch(e){s(e)}finally{a(!1)}})})),{modules:e,loading:n,error:i}})(),{ensureGraphicsLayer:_,clearGraphics:L,removeGraphicsForFnr:Q,addGraphicsToMap:z,destroyGraphicsLayer:J}=m(f,i),{disablePopup:K,restorePopup:Y}=(()=>{const e=r.React.useRef(null),o=r.hooks.useEventCallback((r=>{if(!r)return;const o=r.popup;o&&null!==e.current&&(o.autoOpenEnabled=e.current,e.current=null)})),t=r.hooks.useEventCallback((r=>{if(!r)return;const o=r.popup;o&&"boolean"==typeof o.autoOpenEnabled&&(null===e.current&&(e.current=o.autoOpenEnabled),o.autoOpenEnabled=!1)})),n=r.hooks.useEventCallback((e=>{o(e)}));return{disablePopup:t,restorePopup:o,cleanup:n}})(),{getController:X,releaseController:Z,abortAll:ee}=(()=>{const e=r.React.useRef([]),o=r.React.useRef(new Set),t=r.hooks.useEventCallback((()=>{const r=e.current.pop()||new AbortController;return o.current.add(r),r})),n=r.hooks.useEventCallback((e=>{o.current.delete(e)})),a=r.hooks.useEventCallback((()=>{o.current.forEach((e=>{e.signal.aborted||e.abort()})),o.current.clear(),e.current=[]}));return r.hooks.useUnmount((()=>{a()})),{getController:t,releaseController:n,abortAll:a}})(),re=r.React.useRef(null);re.current||(re.current=r.DataSourceManager.getInstance());const oe=r.React.useRef(0),[te,ne]=r.React.useState({loading:!1,error:null,selectedProperties:[],undoHistory:[]}),ae=a.maxResults,ie=a.enableToggleRemoval,se=a.enablePIIMasking,le=null==s?void 0:s[0],ce=r.hooks.useEventCallback((e=>{Q(e,I),ne((r=>{const o=[],t=[];if(r.selectedProperties.forEach((r=>{r.FNR!==e?t.push(r):o.push(r)})),0===o.length)return r;const n=[{type:"remove",timestamp:Date.now(),data:o},...r.undoHistory].slice(0,10);return B({category:"Property",action:"remove",value:o.length}),Object.assign(Object.assign({},r),{selectedProperties:t,undoHistory:n})}))})),ue=r.hooks.useEventCallback((()=>{ee(),G(),L(),ne((e=>{const r=[{type:"clear",timestamp:Date.now(),data:e.selectedProperties},...e.undoHistory].slice(0,10);return B({category:"Property",action:"clear_all",value:e.selectedProperties.length}),Object.assign(Object.assign({},e),{selectedProperties:[],error:null,undoHistory:r})}))})),de=r.hooks.useEventCallback((()=>{if(0===te.undoHistory.length)return;const[e,...r]=te.undoHistory;ne((o=>{let t=[...o.selectedProperties];return"remove"===e.type?t=[...o.selectedProperties,...e.data]:"clear"===e.type&&(t=e.data),e.data.length>0&&V({graphicsToAdd:e.data.map((e=>({graphic:e.graphic,fnr:e.FNR}))),selectedRows:t,getCurrentView:he,helpers:{addGraphicsToMap:z,extractFnr:k,normalizeFnrKey:I},highlightColor:v,outlineWidth:2}),B({category:"Property",action:"undo",label:e.type}),Object.assign(Object.assign({},o),{selectedProperties:t,undoHistory:r})}))})),pe=r.hooks.useEventCallback(((e,r,o)=>{ne((t=>Object.assign(Object.assign({},t),{loading:!1,error:{type:e,message:r,details:o}})))})),ge=r.hooks.useEventCallback((r=>W(void 0,void 0,void 0,(function*(){ee();const o=(e=>{const r=performance.now();return{success:()=>{const o=performance.now()-r;H({operation:e,duration:o,success:!0})},failure:o=>{const t=performance.now()-r;H({operation:e,duration:t,success:!1,error:o})}}})("map_click_query"),t=((e,r,o,t)=>{if(!r)return{valid:!1,error:{type:"VALIDATION_ERROR",message:"Modules not loaded"}};const n=null==e?void 0:e.mapPoint;return n?{valid:!0,mapPoint:n}:{valid:!1,error:{type:"GEOMETRY_ERROR",message:t("errorNoMapPoint")}}})(r,f,0,c);if(!t.valid){const{error:e}=t;return pe(e.type,e.message),o.failure(e.type),void q("map_click_validation",e.type,e.message)}const{mapPoint:n}=t,i=(e=>{const{propertyDsId:r,ownerDsId:o,dsManager:t,allowedHosts:n,translate:a}=e;if(!r||!o)return{valid:!1,error:{type:"VALIDATION_ERROR",message:a("errorNoDataAvailable")},failureReason:"missing_data_sources"};if(!t)return{valid:!1,error:{type:"QUERY_ERROR",message:a("errorQueryFailed")},failureReason:"no_data_source_manager"};const i=t.getDataSource(r),s=t.getDataSource(o);if(!i||!s)return{valid:!1,error:{type:"VALIDATION_ERROR",message:a("errorNoDataAvailable")},failureReason:"missing_data_source_instance"};if("function"!=typeof i.query)return{valid:!1,error:{type:"VALIDATION_ERROR",message:a("errorNoDataAvailable")},failureReason:"property_ds_not_queryable"};if("function"!=typeof s.query)return{valid:!1,error:{type:"VALIDATION_ERROR",message:a("errorNoDataAvailable")},failureReason:"owner_ds_not_queryable"};const l=null==n?void 0:n.map((e=>e.trim())).filter((e=>e.length>0)),c=x(i);if(!c||!A(c,l&&l.length>0?l:void 0))return{valid:!1,error:{type:"VALIDATION_ERROR",message:a("errorHostNotAllowed")},failureReason:"property_disallowed_host"};const u=x(s);return u&&A(u,l&&l.length>0?l:void 0)?{valid:!0,manager:t}:{valid:!1,error:{type:"VALIDATION_ERROR",message:a("errorHostNotAllowed")},failureReason:"owner_disallowed_host"}})({propertyDsId:a.propertyDataSourceId,ownerDsId:a.ownerDataSourceId,dsManager:re.current,allowedHosts:a.allowedHosts,translate:c});if((e=>!e.valid)(i)){const{error:e,failureReason:r}=i;return pe(e.type,e.message),o.failure(r),void q("map_click",r)}const{manager:s}=i,l=oe.current+1;oe.current=l;const u=()=>l!==oe.current;ne((e=>Object.assign(Object.assign({},e),{loading:!0,error:null})));const d=X();try{const e=yield(g=n,y=a.propertyDataSourceId,m=s,b={signal:d.signal},C(void 0,void 0,void 0,(function*(){var e;const r=D("property",{x:Math.round(100*g.x)/100,y:Math.round(100*g.y)/100,wkid:null===(e=g.spatialReference)||void 0===e?void 0:e.wkid,dsId:y});return M(h,r,(()=>C(void 0,void 0,void 0,(function*(){var e,r;try{if(null===(e=null==b?void 0:b.signal)||void 0===e?void 0:e.aborted){const e=new Error("AbortError");throw e.name="AbortError",e}const o=m.getDataSource(y);if(!o)throw new Error("Property data source not found");const t=yield o.query({geometry:g,returnGeometry:!0,outFields:["*"],spatialRel:"esriSpatialRelIntersects"});if(null===(r=null==b?void 0:b.signal)||void 0===r?void 0:r.aborted){const e=new Error("AbortError");throw e.name="AbortError",e}return(null==t?void 0:t.records)?t.records.map((e=>{const r=e.getData();return{features:[r],propertyId:r.attributes.FNR}})):[]}catch(e){if(F(e))throw e;throw new Error(T(e,"Property query failed"))}}))))})));if(d.signal.aborted||u()){if(u())return;return ne((e=>Object.assign(Object.assign({},e),{loading:!1}))),void o.failure("aborted")}if(!e.length){if(u())return;return ne((e=>Object.assign(Object.assign({},e),{loading:!1}))),o.success(),void B({category:"Query",action:"property_query",label:"no_results"})}const{rowsToProcess:r,graphicsToAdd:t}=yield(p={propertyResults:e,config:{ownerDataSourceId:a.ownerDataSourceId,enablePIIMasking:se},dsManager:s,maxResults:ae,signal:d.signal,helpers:{extractFnr:k,queryOwnerByFnr:N,createRowId:O,formatPropertyWithShare:E,formatOwnerInfo:R,isAbortError:F},messages:{unknownOwner:c("unknownOwner"),errorOwnerQueryFailed:c("errorOwnerQueryFailed"),errorNoDataAvailable:c("errorNoDataAvailable")}},w(void 0,void 0,void 0,(function*(){const{propertyResults:e,config:r,dsManager:o,maxResults:t,helpers:n,messages:a,signal:i}=p,s=[],l=[],c=new Set,u=[];for(const r of e){const e=j(r,n.extractFnr);e&&!c.has(e.fnr)&&(c.add(e.fnr),u.push(e))}for(let e=0;e<u.length;){const c=t-l.length;if(c<=0)break;const d=Math.min(c,5,u.length-e),p=u.slice(e,e+d),{rows:g,graphics:v}=yield P({batch:p,config:{ownerDataSourceId:r.ownerDataSourceId,enablePIIMasking:r.enablePIIMasking},dsManager:o,maxResults:t,currentRowCount:l.length,signal:i,helpers:{queryOwnerByFnr:n.queryOwnerByFnr,isAbortError:n.isAbortError,createRowId:n.createRowId,formatPropertyWithShare:n.formatPropertyWithShare,formatOwnerInfo:n.formatOwnerInfo},messages:a});l.push(...g),s.push(...v),e+=d}return{rowsToProcess:l,graphicsToAdd:s}})));if(d.signal.aborted||u()){if(u())return;return ne((e=>Object.assign(Object.assign({},e),{loading:!1}))),void o.failure("aborted")}let i=null,l=null;if(u())return;if(ne((e=>{if(u())return e;const{updatedRows:o}=((e,r,o,t)=>{const n=new Set,a=[],i=new Set(r.map((e=>I(e.FNR))));for(const r of e){const e=I(r.FNR);o&&i.has(e)?(n.add(e),i.delete(e)):i.has(e)||n.has(e)||(a.push(r),i.add(e))}const s=[...r.filter((e=>!n.has(I(e.FNR)))),...a];return s.length>t&&(s.length=t),{toRemove:n,toAdd:a,updatedRows:s}})(r,e.selectedProperties,ie,ae);return i={updatedRows:o,previousRows:e.selectedProperties},l={graphicsToAdd:t,selectedRows:o,getCurrentView:he,helpers:{addGraphicsToMap:z,extractFnr:k,normalizeFnrKey:I},highlightColor:v,outlineWidth:2},Object.assign(Object.assign({},e),{loading:!1,selectedProperties:o})})),i&&(e=>{const{updatedRows:r,previousRows:o,removeGraphicsForFnr:t,normalizeFnrKey:n}=e,a=new Set(r.map((e=>n(e.FNR))));o.forEach((e=>{const r=n(e.FNR);a.has(r)||t(e.FNR,n)}))})({updatedRows:i.updatedRows,previousRows:i.previousRows,removeGraphicsForFnr:Q,normalizeFnrKey:I}),l&&V(l),u())return;o.success(),B({category:"Query",action:"property_query",label:"success",value:r.length}),U("pii_masking",se),U("toggle_removal",ie)}catch(r){if(u())return;if(F(r))return ne((e=>Object.assign(Object.assign({},e),{loading:!1}))),void o.failure("aborted");pe(e.QUERY_ERROR,c("errorQueryFailed")),o.failure("query_error"),q("property_query",r)}finally{Z(d)}var p,g,y,m,b})))),{onActiveViewChange:ve,getCurrentView:he}=(e=>{const{modules:o,ensureGraphicsLayer:t,destroyGraphicsLayer:n,disablePopup:a,restorePopup:i,onMapClick:s}=e,l=r.React.useRef(null),c=r.React.useRef(null),u=r.hooks.useEventCallback((e=>{a(e),t(e),c.current&&c.current.remove(),c.current=e.on("click",s)})),d=r.hooks.useEventCallback((()=>{var e;const r=null===(e=l.current)||void 0===e?void 0:e.view;r&&(i(r),n(r))})),p=r.hooks.useEventCallback((e=>{var r;if(!o)return;const t=null==e?void 0:e.view;if(!t)return;const n=null===(r=l.current)||void 0===r?void 0:r.view;n&&n!==t&&d(),l.current=e,u(t)})),g=r.hooks.useEventCallback((()=>{var e;const r=null===(e=l.current)||void 0===e?void 0:e.view;i(r),c.current&&(c.current.remove(),c.current=null),r&&n(r)}));return r.hooks.useUnmount((()=>{g()})),{onActiveViewChange:p,getCurrentView:()=>{var e;return null===(e=l.current)||void 0===e?void 0:e.view},cleanup:g}})({modules:f,ensureGraphicsLayer:_,destroyGraphicsLayer:J,disablePopup:K,restorePopup:Y,onMapClick:ge});return r.hooks.useUnmount((()=>{ee(),G()})),b?(0,r.jsx)("div",{css:l.parent,role:"region","aria-label":c("widgetTitle")},(0,r.jsx)("div",{css:l.loading,role:"status","aria-live":"polite","aria-busy":"true"},(0,r.jsx)(t.Loading,{type:t.LoadingType.Donut}),(0,r.jsx)("div",null,c("loadingModules")))):S?(0,r.jsx)("div",{css:l.parent,role:"region","aria-label":c("widgetTitle")},(0,r.jsx)("div",{css:l.error,role:"alert","aria-live":"assertive"},(0,r.jsx)(t.Alert,{type:"error",withIcon:!0,text:c("errorLoadingModules")}))):(0,r.jsx)("div",{css:l.parent,role:"region","aria-label":c("widgetTitle")},(0,r.jsx)("div",{css:l.header},(0,r.jsx)("div",{css:l.buttons},te.undoHistory.length>0&&(0,r.jsx)(t.Button,{size:"sm",type:"tertiary",onClick:de,"aria-label":c("undoLastAction")},c("undo")),te.selectedProperties.length>0&&(0,r.jsx)(t.Button,{size:"sm",type:"secondary",onClick:ue},c("clearAll")))),(0,r.jsx)("div",{css:l.cols},(0,r.jsx)("div",{css:l.col},c("columnFastighet")),(0,r.jsx)("div",{css:l.col},c("columnOwner"))),(0,r.jsx)("div",{css:l.body,role:"main"},te.loading&&(0,r.jsx)("div",{css:l.loading,role:"status","aria-live":"polite","aria-busy":"true"},(0,r.jsx)(t.Loading,{type:t.LoadingType.Donut}),(0,r.jsx)("div",null,c("loadingData"))),te.error&&(0,r.jsx)("div",{css:l.error,role:"alert","aria-live":"assertive"},(0,r.jsx)(t.Alert,{type:"error",withIcon:!0,text:te.error.message}),te.error.details&&(0,r.jsx)("div",null,te.error.details)),!te.loading&&!te.error&&te.selectedProperties.length>0&&(0,r.jsx)("div",{css:l.list,role:"list","aria-label":c("widgetTitle")},te.selectedProperties.map((e=>(0,r.jsx)("div",{css:l.row,role:"listitem",key:e.id},(0,r.jsx)("div",{css:l.column,"data-column":p},e.FASTIGHET),(0,r.jsx)("div",{css:l.column,"data-column":g},e.BOSTADR),(0,r.jsx)("div",{css:l.actions},(0,r.jsx)(t.Button,{type:"tertiary",size:"sm",onClick:()=>ce(e.FNR),"aria-label":`${c("removeProperty")} ${e.FASTIGHET}`},c("removeProperty")))))))),(0,r.jsx)("div",{css:l.footer},(0,r.jsx)("div",{css:l.col},c("propertySelected")),(0,r.jsx)("div",{css:l.col},te.selectedProperties.length)),le&&(0,r.jsx)(o.JimuMapViewComponent,{useMapWidgetId:le,onActiveViewChange:ve}))},J=e=>{const o=u(),t=r.hooks.useTranslation($);return(0,r.jsx)(Q,{styles:o,translate:t},(0,r.jsx)(z,Object.assign({},e)))};function K(e){i.p=e}})(),s})())}}}));